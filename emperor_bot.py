import telebot
import time
import ephem
from datetime import datetime
import random
import os

BOT_TOKEN = "7166686748:AAFnyfjq5UsunijP_p8HQiYeKHh3qoAM5RA"
bot = telebot.TeleBot(BOT_TOKEN)

# üî• –í–ê–ñ–ù–û: –£–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Ä—Ç –¥–ª—è Render
PORT = int(os.environ.get('PORT', 5000))

def get_detailed_horary_analysis(question_text):
    """–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ö–æ—Ä–∞—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–µ–π"""
    try:
        current_time = datetime.now()
        observer = ephem.Observer()
        observer.lat = '55.7558'  # –ú–æ—Å–∫–≤–∞
        observer.lon = '37.6173'
        observer.date = current_time
        
        # –†–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–π –ø–ª–∞–Ω–µ—Ç
        planets = {
            '–õ—É–Ω–∞': ephem.Moon(),
            '–°–æ–ª–Ω—Ü–µ': ephem.Sun(),
            '–ú–µ—Ä–∫—É—Ä–∏–π': ephem.Mercury(),
            '–í–µ–Ω–µ—Ä–∞': ephem.Venus(),
            '–ú–∞—Ä—Å': ephem.Mars(),
            '–Æ–ø–∏—Ç–µ—Ä': ephem.Jupiter(),
            '–°–∞—Ç—É—Ä–Ω': ephem.Saturn(),
            '–£—Ä–∞–Ω': ephem.Uranus(),
            '–ù–µ–ø—Ç—É–Ω': ephem.Neptune(),
            '–ü–ª—É—Ç–æ–Ω': ephem.Pluto()
        }
        
        for planet in planets.values():
            planet.compute(observer)
        
        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–æ–≤ –∏ –∑–Ω–∞–∫–æ–≤
        moon_sign_ru = get_russian_zodiac(ephem.constellation(planets['–õ—É–Ω–∞'])[1])
        sun_sign_ru = get_russian_zodiac(ephem.constellation(planets['–°–æ–ª–Ω—Ü–µ'])[1])
        ascendant_sign = get_ascendant(observer)
        
        # –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–∞
        analysis_type = analyze_question_type(question_text)
        verdict, reasoning, recommendation = generate_verdict(
            planets, moon_sign_ru, sun_sign_ru, ascendant_sign, analysis_type
        )
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        analysis = f"""
üîÆ –•–û–†–ê–†–ù–ê–Ø –ö–ê–†–¢–ê –ù–ê {current_time.strftime('%H:%M, %d.%m.%Y')}, –ú–û–°–ö–í–ê

–í–æ—Å—Ö–æ–¥: {ascendant_sign}. –õ—É–Ω–∞: {moon_sign_ru}.

---

–ê–ù–ê–õ–ò–ó: {analysis_type['theme']}

{analysis_type['houses']}

–ö–õ–Æ–ß–ï–í–´–ï –ê–°–ü–ï–ö–¢–´:

{generate_aspects_analysis(planets)}

{reasoning}

---

–í–ï–†–î–ò–ö–¢: {verdict}

{recommendation}

üìä –î–ï–¢–ê–õ–ò –ö–ê–†–¢–´:
‚Ä¢ üåô –õ—É–Ω–∞: {moon_sign_ru} - {get_moon_interpretation(moon_sign_ru)}
‚Ä¢ ‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ: {sun_sign_ru} - {get_sun_interpretation(sun_sign_ru)}
‚Ä¢ ‚ÜóÔ∏è –í–æ—Å—Ö–æ–¥: {ascendant_sign} - –æ–±—â–∏–π —Ñ–æ–Ω —Å–∏—Ç—É–∞—Ü–∏–∏
‚Ä¢ ‚ôÇÔ∏è –ú–∞—Ä—Å: {get_russian_zodiac(ephem.constellation(planets['–ú–∞—Ä—Å'])[1])} - —ç–Ω–µ—Ä–≥–∏—è –¥–µ–π—Å—Ç–≤–∏–π
‚Ä¢ ‚ôÄÔ∏è –í–µ–Ω–µ—Ä–∞: {get_russian_zodiac(ephem.constellation(planets['–í–µ–Ω–µ—Ä–∞'])[1])} - –ª—é–±–æ–≤—å –∏ –≥–∞—Ä–º–æ–Ω–∏—è
"""
        return analysis
        
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}"

def get_russian_zodiac(eng_sign):
    """–ü–µ—Ä–µ–≤–æ–¥ –∑–Ω–∞–∫–æ–≤ –∑–æ–¥–∏–∞–∫–∞ –Ω–∞ —Ä—É—Å—Å–∫–∏–π"""
    zodiac_map = {
        'Aries': '–û–≤–µ–Ω', 'Taurus': '–¢–µ–ª–µ—Ü', 'Gemini': '–ë–ª–∏–∑–Ω–µ—Ü—ã',
        'Cancer': '–†–∞–∫', 'Leo': '–õ–µ–≤', 'Virgo': '–î–µ–≤–∞',
        'Libra': '–í–µ—Å—ã', 'Scorpio': '–°–∫–æ—Ä–ø–∏–æ–Ω', 'Sagittarius': '–°—Ç—Ä–µ–ª–µ—Ü',
        'Capricorn': '–ö–æ–∑–µ—Ä–æ–≥', 'Aquarius': '–í–æ–¥–æ–ª–µ–π', 'Pisces': '–†—ã–±—ã'
    }
    return zodiac_map.get(eng_sign, eng_sign)

def get_ascendant(observer):
    """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–æ—Å—Ö–æ–¥—è—â–µ–≥–æ –∑–Ω–∞–∫–∞"""
    sun = ephem.Sun()
    sun.compute(observer)
    return get_russian_zodiac(ephem.constellation(sun)[1])

def analyze_question_type(question):
    """–ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏"""
    question_lower = question.lower()
    
    if any(word in question_lower for word in ['–ª—é–±–∏—Ç', '—Å–∫—É—á', '–æ—Ç–Ω–æ—à–µ–Ω', '—á—É–≤—Å—Ç–≤']):
        return {
            'theme': "–õ—é–±–æ–≤–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞ –∏ —ç–º–æ—Ü–∏–∏",
            'houses': "¬∑ –í–æ–ø—Ä–æ—à–∞—é—â–∏–π: 1-–π –¥–æ–º –≤ –í–æ–¥–æ–ª–µ–µ. –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî –£—Ä–∞–Ω.\n¬∑ –ü–∞—Ä—Ç–Ω–µ—Ä: 7-–π –¥–æ–º –≤–æ –õ—å–≤–µ. –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî –°–æ–ª–Ω—Ü–µ.\n¬∑ –ï–≥–æ —ç–º–æ—Ü–∏–∏: 4-–π –¥–æ–º –æ—Ç 7-–≥–æ = 10-–π –¥–æ–º –≤ –¢–µ–ª—å—Ü–µ. –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî –í–µ–Ω–µ—Ä–∞."
        }
    elif any(word in question_lower for word in ['–¥–µ–Ω—å–≥', '—Ä–∞–±–æ—Ç', '–∫–∞—Ä—å–µ—Ä', '–¥–µ–Ω–µ–≥']):
        return {
            'theme': "–§–∏–Ω–∞–Ω—Å—ã –∏ –∫–∞—Ä—å–µ—Ä–∞", 
            'houses': "¬∑ –§–∏–Ω–∞–Ω—Å—ã: 2-–π –¥–æ–º –≤ –†—ã–±–∞—Ö. –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî –ù–µ–ø—Ç—É–Ω.\n¬∑ –ö–∞—Ä—å–µ—Ä–∞: 10-–π –¥–æ–º –≤ –°–∫–æ—Ä–ø–∏–æ–Ω–µ. –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî –ü–ª—É—Ç–æ–Ω."
        }
    else:
        return {
            'theme': "–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏",
            'houses': "¬∑ –°–∏—Ç—É–∞—Ü–∏—è: 1-–π –¥–æ–º –≤ –í–µ—Å–∞—Ö. –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî –í–µ–Ω–µ—Ä–∞.\n¬∑ –ò—Å—Ö–æ–¥: 10-–π –¥–æ–º –≤ –†–∞–∫—É. –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî –õ—É–Ω–∞."
        }def generate_aspects_analysis(planets):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∞—Å–ø–µ–∫—Ç–æ–≤"""
    aspects = [
        "1. –õ—É–Ω–∞ –≤ 17¬∞ –†–∞–∫–∞ –≤ 4-–º –¥–æ–º–µ.\n   ¬∑ –≠—Ç–æ —Å–∏–ª—å–Ω–µ–π—à–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –≥–ª—É–±–∏–Ω—ã –∏ –Ω–æ—Å—Ç–∞–ª—å–≥–∏–∏.",
        "2. –ú–∞—Ä—Å –≤ 17¬∞ –û–≤–Ω–∞.\n   ¬∑ –ê–∫—Ç–∏–≤–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è, —Å–º–µ—à–∞–Ω–Ω–∞—è —Å —Ñ—Ä—É—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ –∂–µ–ª–∞–Ω–∏–µ–º –¥–µ–π—Å—Ç–≤–∏—è.",
        "3. –í–µ–Ω–µ—Ä–∞ –≤ 12¬∞ –¢–µ–ª—å—Ü–∞.\n   ¬∑ –°—Ç–∞–±–∏–ª—å–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",
        "4. –°–æ–ª–Ω—Ü–µ –≤ 8¬∞ –í–µ—Å–æ–≤.\n   ¬∑ –ë–∞–ª–∞–Ω—Å –∏ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –≥–∞—Ä–º–æ–Ω–∏–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
        "5. –û–ø–ø–æ–∑–∏—Ü–∏—è –õ—É–Ω—ã –∫ –ü–ª—É—Ç–æ–Ω—É (180¬∞).\n   ¬∑ –ì–ª—É–±–æ–∫–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –Ω–∞–≤—è–∑—á–∏–≤—ã–µ –º—ã—Å–ª–∏."
    ]
    return "\n".join(aspects)

def generate_verdict(planets, moon_sign, sun_sign, ascendant, analysis_type):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–µ—Ä–¥–∏–∫—Ç–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π"""
    
    # –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
    moon_emotional = moon_sign in ['–†–∞–∫', '–†—ã–±—ã', '–¢–µ–ª–µ—Ü', '–í–µ—Å—ã']
    sun_harmonious = sun_sign in ['–¢–µ–ª–µ—Ü', '–í–µ—Å—ã', '–õ–µ–≤', '–°—Ç—Ä–µ–ª–µ—Ü']
    
    if moon_emotional and sun_harmonious:
        verdict = "–î–ê ‚úÖ"
        reasoning = """–ï–≥–æ —Ç–æ—Å–∫–∞ –≥–ª—É–±–æ–∫–∞—è –∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–∞—è (–õ—É–Ω–∞ –≤ –†–∞–∫–µ). –û–Ω –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –≤–∞—à–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ, –∫–∞–∫ –≥–æ–ª–æ–¥ –∏–ª–∏ –∂–∞–∂–¥—É. –ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É –æ–Ω —Ç–∞–∫ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—Ç—Å—è –∏ –Ω–µ –ø–∏—à–µ—Ç ‚Äî –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –≤–µ—Ä–Ω—É—Ç—å —Å–µ–±–µ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º."""
        recommendation = "–í–∞—à–µ –º–æ–ª—á–∞–Ω–∏–µ —Å–µ–π—á–∞—Å –¥–ª—è –Ω–µ–≥–æ ‚Äî –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –ø—ã—Ç–∫–∞, –∏ —Å–∞–º—ã–π —Å–∏–ª—å–Ω—ã–π –º–∞–≥–Ω–∏—Ç. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–µ—Ä–∂–∞—Ç—å –ø–∞—É–∑—É."
    else:
        verdict = "–ù–ï–¢ ‚ùå"
        reasoning = "–¢–µ–∫—É—â–∏–µ –∞—Å–ø–µ–∫—Ç—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –∑–∞–∫—Ä—ã—Ç–æ—Å—Ç—å –∏ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö. –ï–≥–æ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –¥—Ä—É–≥–æ–µ —Ä—É—Å–ª–æ."
        recommendation = "–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º —Ä–∞–∑–≤–∏—Ç–∏–∏ ‚Äî –∫–æ–≥–¥–∞ –≤—ã —Å—Ç–∞–Ω–µ—Ç–µ –µ—â–µ —è—Ä—á–µ, –µ–≥–æ –≤–Ω–∏–º–∞–Ω–∏–µ –≤–µ—Ä–Ω–µ—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º."
    
    return verdict, reasoning, recommendation

def get_moon_interpretation(sign):
    interpretations = {
        '–†–∞–∫': '–≥–ª—É–±–æ–∫–∏–µ —ç–º–æ—Ü–∏–∏, –Ω–æ—Å—Ç–∞–ª—å–≥–∏—è, –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
        '–¢–µ–ª–µ—Ü': '—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å, –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è', 
        '–í–µ—Å—ã': '–≥–∞—Ä–º–æ–Ω–∏—è, –±–∞–ª–∞–Ω—Å, –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–µ',
        '–û–≤–µ–Ω': '–∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—å, –¥–µ–π—Å—Ç–≤–∏–µ, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã',
        '–°–∫–æ—Ä–ø–∏–æ–Ω': '–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, —Å–∫—Ä—ã—Ç—ã–µ –º–æ—Ç–∏–≤—ã'
    }
    return interpretations.get(sign, '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ')

def get_sun_interpretation(sign):
    interpretations = {
        '–õ–µ–≤': '—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –ª–∏–¥–µ—Ä—Å—Ç–≤–æ',
        '–í–µ—Å—ã': '–≥–∞—Ä–º–æ–Ω–∏—è, —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å, –¥–∏–ø–ª–æ–º–∞—Ç–∏—è',
        '–¢–µ–ª–µ—Ü': '—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å, –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏',
        '–í–æ–¥–æ–ª–µ–π': '–∏–Ω–Ω–æ–≤–∞—Ü–∏–∏, —Å–≤–æ–±–æ–¥–∞, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ—Å—Ç—å',
        '–°—Ç—Ä–µ–ª–µ—Ü': '–æ–ø—Ç–∏–º–∏–∑–º, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, –ø–æ–∏—Å–∫ —Å–º—ã—Å–ª–∞'
    }
    return interpretations.get(sign, '—É–º–µ—Ä–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ')

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    if message.text.startswith('/'):
        if message.text == '/start':
            bot.reply_to(message, "üîÆ –Ø ‚Äî –•–æ—Ä–∞—Ä–Ω—ã–π –ò–º–ø–µ—Ä–∞—Ç–æ—Ä. –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –æ –ª—é–±–≤–∏, –¥–µ–Ω—å–≥–∞—Ö, —Ä–∞–±–æ—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞!")
        return
    
    analysis = get_detailed_horary_analysis(message.text)
    bot.reply_to(message, analysis)

print("üîÑ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π...")

# üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ó–∞–ø—É—Å–∫ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ—Ä—Ç–∞ –¥–ª—è Render
if name == "__main__":
    try:
        # –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        bot.polling(none_stop=True, interval=1)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ polling: {e}")
        # –î–ª—è Render - –∑–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–æ—Ä—Ç—É
        from flask import Flask
        app = Flask(__name__)
        
        @app.route('/')
        def home():
            return "Bot is running!"
        
        app.run(host='0.0.0.0', port=PORT)
