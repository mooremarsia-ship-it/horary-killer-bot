import telebot
import time
import ephem
from datetime import datetime
import os
from flask import Flask

# üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ø–æ—Ä—Ç –¥–ª—è Render
PORT = int(os.environ.get('PORT', 5000))

BOT_TOKEN = "7166686748:AAFnyfjq5UsunijP_p8HQiYeKHh3qoAM5RA"
bot = telebot.TeleBot(BOT_TOKEN)

def get_russian_zodiac(eng_sign):
    """–ü–µ—Ä–µ–≤–æ–¥ –∑–Ω–∞–∫–æ–≤ –∑–æ–¥–∏–∞–∫–∞ –Ω–∞ —Ä—É—Å—Å–∫–∏–π"""
    zodiac_map = {
        'Aries': '–û–≤–µ–Ω', 'Taurus': '–¢–µ–ª–µ—Ü', 'Gemini': '–ë–ª–∏–∑–Ω–µ—Ü—ã',
        'Cancer': '–†–∞–∫', 'Leo': '–õ–µ–≤', 'Virgo': '–î–µ–≤–∞',
        'Libra': '–í–µ—Å—ã', 'Scorpio': '–°–∫–æ—Ä–ø–∏–æ–Ω', 'Sagittarius': '–°—Ç—Ä–µ–ª–µ—Ü',
        'Capricorn': '–ö–æ–∑–µ—Ä–æ–≥', 'Aquarius': '–í–æ–¥–æ–ª–µ–π', 'Pisces': '–†—ã–±—ã'
    }
    return zodiac_map.get(eng_sign, eng_sign)

def detect_question_theme(question):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–º—É –≤–æ–ø—Ä–æ—Å–∞ (–ó–ê–ú–ï–ù–ê –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–º—É horary_knowledge)"""
    question_lower = question.lower()
    
    if any(word in question_lower for word in ['–ª—é–±–∏—Ç', '—Å–∫—É—á', '–æ—Ç–Ω–æ—à–µ–Ω', '—á—É–≤—Å—Ç–≤']):
        return "7-–π –¥–æ–º", "–ü–∞—Ä—Ç–Ω–µ—Ä, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –ª—é–±–æ–≤—å"
    elif any(word in question_lower for word in ['–¥–µ–Ω—å–≥', '—Ä–∞–±–æ—Ç', '–∫–∞—Ä—å–µ—Ä', '–¥–µ–Ω–µ–≥']):
        return "2-–π –¥–æ–º", "–î–µ–Ω—å–≥–∏, —Ñ–∏–Ω–∞–Ω—Å—ã, —Ä–µ—Å—É—Ä—Å—ã" 
    elif any(word in question_lower for word in ['–∑–¥–æ—Ä–æ–≤', '–±–æ–ª–µ–∑']):
        return "6-–π –¥–æ–º", "–ó–¥–æ—Ä–æ–≤—å–µ, –±–æ–ª–µ–∑–Ω–∏"
    else:
        return "1-–π –¥–æ–º", "–õ–∏—á–Ω–æ—Å—Ç—å, –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"

def get_planet_ruler(sign):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∑–Ω–∞–∫–∞ (–ó–ê–ú–ï–ù–ê –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–º—É horary_knowledge)"""
    rulers = {
        'Aries': '–ú–∞—Ä—Å', 'Taurus': '–í–µ–Ω–µ—Ä–∞', 'Gemini': '–ú–µ—Ä–∫—É—Ä–∏–π',
        'Cancer': '–õ—É–Ω–∞', 'Leo': '–°–æ–ª–Ω—Ü–µ', 'Virgo': '–ú–µ—Ä–∫—É—Ä–∏–π', 
        'Libra': '–í–µ–Ω–µ—Ä–∞', 'Scorpio': '–ü–ª—É—Ç–æ–Ω', 'Sagittarius': '–Æ–ø–∏—Ç–µ—Ä',
        'Capricorn': '–°–∞—Ç—É—Ä–Ω', 'Aquarius': '–£—Ä–∞–Ω', 'Pisces': '–ù–µ–ø—Ç—É–Ω'
    }
    return rulers.get(sign, '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')

def get_detailed_horary_analysis(question_text):
    """–†–ê–°–®–ò–†–ï–ù–ù–´–ô —Ö–æ—Ä–∞—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∫ —Ç—ã —Ö–æ—á–µ—à—å"""
    try:
        current_time = datetime.now()
        observer = ephem.Observer()
        observer.lat = '55.7558'  # –ú–æ—Å–∫–≤–∞
        observer.lon = '37.6173'
        observer.date = current_time
        
        # –†–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–π –ø–ª–∞–Ω–µ—Ç
        planets = {
            '–õ—É–Ω–∞': ephem.Moon(),
            '–°–æ–ª–Ω—Ü–µ': ephem.Sun(),
            '–ú–µ—Ä–∫—É—Ä–∏–π': ephem.Mercury(),
            '–í–µ–Ω–µ—Ä–∞': ephem.Venus(), 
            '–ú–∞—Ä—Å': ephem.Mars(),
            '–Æ–ø–∏—Ç–µ—Ä': ephem.Jupiter()
        }
        
        for planet in planets.values():
            planet.compute(observer)
        
        # –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π
        moon_sign_ru = get_russian_zodiac(ephem.constellation(planets['–õ—É–Ω–∞'])[1])
        sun_sign_ru = get_russian_zodiac(ephem.constellation(planets['–°–æ–ª–Ω—Ü–µ'])[1])
        mars_sign_ru = get_russian_zodiac(ephem.constellation(planets['–ú–∞—Ä—Å'])[1])
        venus_sign_ru = get_russian_zodiac(ephem.constellation(planets['–í–µ–Ω–µ—Ä–∞'])[1])
        
        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–æ—Å—Ö–æ–¥—è—â–µ–≥–æ –∑–Ω–∞–∫–∞
        ascendant_ru = get_russian_zodiac(ephem.constellation(planets['–°–æ–ª–Ω—Ü–µ'])[1])
        
        # –ê–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–∞
        question_house, house_meaning = detect_question_theme(question_text)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –†–ê–ó–í–ï–†–ù–£–¢–û–ì–û –æ—Ç–≤–µ—Ç–∞
        analysis = f"""
üîÆ –•–û–†–ê–†–ù–ê–Ø –ö–ê–†–¢–ê –ù–ê {current_time.strftime('%H:%M, %d.%m.%Y')}, –ú–û–°–ö–í–ê

–í–æ—Å—Ö–æ–¥: {ascendant_ru}. –õ—É–Ω–∞: {moon_sign_ru}.

---

–ê–ù–ê–õ–ò–ó: {question_text}

¬∑ –í–æ–ø—Ä–æ—à–∞—é—â–∏–π: 1-–π –¥–æ–º –≤ –í–µ—Å–∞—Ö. –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî –í–µ–Ω–µ—Ä–∞.
¬∑ –ü–∞—Ä—Ç–Ω–µ—Ä: 7-–π –¥–æ–º –≤ –û–≤–Ω–µ. –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî –ú–∞—Ä—Å.  
¬∑ –ï–≥–æ —ç–º–æ—Ü–∏–∏: 4-–π –¥–æ–º –æ—Ç 7-–≥–æ = 10-–π –¥–æ–º –≤ –†–∞–∫–µ. –£–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî –õ—É–Ω–∞.

–ö–õ–Æ–ß–ï–í–´–ï –ê–°–ü–ï–ö–¢–´:

1. –õ—É–Ω–∞ –≤ 17¬∞ {moon_sign_ru} –≤ 4-–º –¥–æ–º–µ.
   ¬∑ –≠—Ç–æ —Å–∏–ª—å–Ω–µ–π—à–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —Ç–æ—Å–∫–∏. –õ—É–Ω–∞ –≤ {moon_sign_ru} ‚Äî —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–ª—É–±–æ–∫–æ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, –Ω–æ—Å—Ç–∞–ª—å–≥–∏–∏, –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –∫–æ–º—Ñ–æ—Ä—Ç–µ.

2. –ú–∞—Ä—Å –≤ 17¬∞ {mars_sign_ru}.
   ¬∑ –ï–≥–æ —Ç–æ—Å–∫–∞ —Å–º–µ—à–∞–Ω–∞ —Å —Ñ—Ä—É—Å—Ç—Ä–∞—Ü–∏–µ–π (–ú–∞—Ä—Å –≤ {mars_sign_ru}). –ï–º—É –Ω–µ –ø—Ä–æ—Å—Ç–æ –≥—Ä—É—Å—Ç–Ω–æ ‚Äî –µ–º—É –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –æ—Ç —ç—Ç–æ–≥–æ —á—É–≤—Å—Ç–≤–∞, –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è —Å –Ω–∏–º –±–æ—Ä–æ—Ç—å—Å—è.

3. –í–µ–Ω–µ—Ä–∞ –≤ 12¬∞ {venus_sign_ru}.
   ¬∑ –°—Ç–∞–±–∏–ª—å–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

4. –û–ø–ø–æ–∑–∏—Ü–∏—è –õ—É–Ω—ã –∫ –ü–ª—É—Ç–æ–Ω—É (180¬∞).
   ¬∑ –ï–≥–æ —Ç–æ—Å–∫–∞ ‚Äî –Ω–∞–≤—è–∑—á–∏–≤–∞—è, –≥–ª—É–±–æ–∫–∞—è, –ø–æ—á—Ç–∏ –±–æ–ª–µ–∑–Ω–µ–Ω–Ω–∞—è.–û–Ω –Ω–µ –º–æ–∂–µ—Ç ¬´–ø—Ä–æ—Å—Ç–æ –≤—Å–ø–æ–º–Ω–∏—Ç—å¬ª –æ –≤–∞—Å ‚Äî –≤–∞—à –æ–±—Ä–∞–∑ –≤—Å–ø–ª—ã–≤–∞–µ—Ç —Å —Å–∏–ª–æ–π, –∫–æ—Ç–æ—Ä—É—é –æ–Ω –Ω–µ –º–æ–∂–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å.

---

–í–ï–†–î–ò–ö–¢: –î–ê ‚úÖ

–û–Ω —Å–∏–ª—å–Ω–æ –ø–æ –≤–∞–º —Å–∫—É—á–∞–µ—Ç. –ù–æ —ç—Ç–æ –Ω–µ –ª—ë–≥–∫–∞—è –≥—Ä—É—Å—Ç—å. –≠—Ç–æ ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ—â–Ω–æ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è.

–ï–≥–æ —Ç–æ—Å–∫–∞:
¬∑ –ì–ª—É–±–æ–∫–∞—è –∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–∞—è (–õ—É–Ω–∞ –≤ {moon_sign_ru})
¬∑ –ù–∞–≤—è–∑—á–∏–≤–∞—è –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É—é—â–∞—è (–∞—Å–ø–µ–∫—Ç –∫ –ü–ª—É—Ç–æ–Ω—É)  
¬∑ –í—ã–∑—ã–≤–∞—é—â–∞—è —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è (–ú–∞—Ä—Å –≤ {mars_sign_ru})

–û–Ω –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´–≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç¬ª –≤–∞—Å. –û–Ω –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –≤–∞—à–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ, –∫–∞–∫ –≥–æ–ª–æ–¥ –∏–ª–∏ –∂–∞–∂–¥—É. –ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É –æ–Ω —Ç–∞–∫ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—Ç—Å—è –∏ –Ω–µ –ø–∏—à–µ—Ç ‚Äî –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –≤–µ—Ä–Ω—É—Ç—å —Å–µ–±–µ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º.

üí´ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –í–∞—à–µ –º–æ–ª—á–∞–Ω–∏–µ —Å–µ–π—á–∞—Å –¥–ª—è –Ω–µ–≥–æ ‚Äî –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –ø—ã—Ç–∫–∞, –∏ —Å–∞–º—ã–π —Å–∏–ª—å–Ω—ã–π –º–∞–≥–Ω–∏—Ç. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–µ—Ä–∂–∞—Ç—å –ø–∞—É–∑—É.

üìä –ü–û–ó–ò–¶–ò–ò –ü–õ–ê–ù–ï–¢:
‚Ä¢ üåô –õ—É–Ω–∞: {moon_sign_ru} - —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω
‚Ä¢ ‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ: {sun_sign_ru} - –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–æ–ª–∏
‚Ä¢ ‚ôÇÔ∏è –ú–∞—Ä—Å: {mars_sign_ru} - —ç–Ω–µ—Ä–≥–∏—è –¥–µ–π—Å—Ç–≤–∏–π  
‚Ä¢ ‚ôÄÔ∏è –í–µ–Ω–µ—Ä–∞: {venus_sign_ru} - –ª—é–±–æ–≤—å –∏ –≥–∞—Ä–º–æ–Ω–∏—è
"""
        return analysis
        
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}"

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    print(f"–ü–æ–ª—É—á–µ–Ω –≤–æ–ø—Ä–æ—Å: {message.text}")
    
    if message.text.startswith('/'):
        if message.text == '/start':
            bot.reply_to(message, "üîÆ –Ø ‚Äî –•–æ—Ä–∞—Ä–Ω—ã–π –ò–º–ø–µ—Ä–∞—Ç–æ—Ä. –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞!")
        return
    
    # –ü—Ä–æ–≤–æ–¥–∏–º –†–ê–°–®–ò–†–ï–ù–ù–´–ô —Ö–æ—Ä–∞—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    analysis = get_detailed_horary_analysis(message.text)
    bot.reply_to(message, analysis)
    print("–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!")

print("üîÑ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å –†–ê–°–®–ò–†–ï–ù–ù–û–ô –ª–æ–≥–∏–∫–æ–π...")

# üî• –ó–ê–ü–£–°–ö –î–õ–Ø RENDER
if name == "__main__":
    try:
        bot.polling(none_stop=True, interval=1)
    except:
        app = Flask(__name__)
        @app.route('/')
        def home(): return "üîÆ –•–æ—Ä–∞—Ä–Ω—ã–π –ò–º–ø–µ—Ä–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω!"
        app.run(host='0.0.0.0', port=PORT)
