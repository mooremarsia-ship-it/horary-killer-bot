import telebot
import time
import ephem
import random
from datetime import datetime, timedelta

BOT_TOKEN = "7166686748:AAFnyfjq5UsunijP_p8HQiYeKHh3qoAM5RA"
bot = telebot.TeleBot(BOT_TOKEN)

class RealityChecker:
    def __init__(self):
        self.absurd_patterns = {
            '–≤—Ä–µ–º—è': ['—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏', '–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å', '–∫–æ–≥–¥–∞ —Å–µ–π—á–∞—Å'],
            '–ø–æ–≥–æ–¥–∞': ['–≤—ã–π–¥–µ—Ç —Å–æ–ª–Ω—Ü–µ', '–±—É–¥–µ—Ç –¥–æ–∂–¥—å', '–∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞'],
            '–º–∞–≥–∏—è': ['–ø–æ–ª—É—á—É –º–∏–ª–ª–∏–æ–Ω', '–ø–æ–¥–∞—Ä—è—Ç –∫–≤–∞—Ä—Ç–∏—Ä—É', '–≤—ã–∏–≥—Ä–∞—é –≤ –ª–æ—Ç–µ—Ä–µ—é'],
            '–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ': ['—Å–µ–≥–æ–¥–Ω—è –∑–∞–º—É–∂', '–∑–∞–≤—Ç—Ä–∞ —Ä–æ–∂—É', '—Å—Ç–∞–Ω—É –±–æ–≥–∞—Ç—ã–º –∑–∞ –¥–µ–Ω—å']
        }
    
    def check_reality(self, question):
        """–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–ø—Ä–æ—Å –Ω–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å"""
        question_lower = question.lower()
        
        # 1. –ü–†–û–í–ï–†–ö–ê –ù–ê –†–ï–ê–õ–ò–ó–ú
        if self._check_timeframe(question_lower):
            return False, "‚è∞ –í–æ–ø—Ä–æ—Å –Ω–∞—Ä—É—à–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏. –•–æ—Ä–∞—Ä –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–±–æ–∑—Ä–∏–º–æ–µ –±—É–¥—É—â–µ–µ, –∞ –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —á—É–¥–µ—Å–∞."
        
        # 2. –ü–†–û–í–ï–†–ö–ê –ù–ê –ö–û–ù–ö–†–ï–¢–ò–ö–£
        if not self._has_specifics(question_lower):
            return False, "üéØ –£—Ç–æ—á–Ω–∏—Ç–µ –≤–æ–ø—Ä–æ—Å: –∫—Ç–æ, —á—Ç–æ, –∫–æ–≥–¥–∞, –∫–∞–∫–∏–µ —Å—Ä–æ–∫–∏? –ë–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏ –∞–Ω–∞–ª–∏–∑ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω."
        
        # 3. –ü–†–û–í–ï–†–ö–ê –ù–ê –ü–ê–°–°–ò–í–ù–û–°–¢–¨  
        if self._is_too_passive(question_lower):
            return False, "üö´ –í–æ–ø—Ä–æ—Å –∏—Å—Ö–æ–¥–∏—Ç –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ '–º–Ω–µ –¥–æ–ª–∂–Ω—ã'. –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–∞—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π."
        
        # 4. –ü–†–û–í–ï–†–ö–ê –ù–ê –ú–ê–°–®–¢–ê–ë
        if self._violates_scale(question_lower):
            return False, "üí´ –í–æ–ø—Ä–æ—Å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç –±–∞–∑–æ–≤—ã–º –∂–∏–∑–Ω–µ–Ω–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º. –•–æ—Ä–∞—Ä - –Ω–µ –≤–æ–ª—à–µ–±–Ω–∞—è –ø–∞–ª–æ—á–∫–∞."
        
        return True, "–í–æ–ø—Ä–æ—Å –ª–µ–≥–∏—Ç–∏–º–µ–Ω"
    
    def _check_timeframe(self, question):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–∞–º–æ–∫"""
        urgent_indicators = ['—Å–µ–≥–æ–¥–Ω—è', '–∑–∞–≤—Ç—Ä–∞', '—Å–µ–π—á–∞—Å', '–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ', '—Å—Ä–æ—á–Ω–æ']
        big_changes = ['–∑–∞–º—É–∂', '—Ä–∞–∑–≤–µ–¥—É—Å—å', '—Ä–æ–∂—É', '—É–º—Ä—É', '—Å—Ç–∞–Ω—É –±–æ–≥–∞—Ç—ã–º', '–ø–æ–ª—É—á—É –º–∏–ª–ª–∏–æ–Ω']
        
        has_urgency = any(word in question for word in urgent_indicators)
        has_big_change = any(word in question for word in big_changes)
        
        return has_urgency and has_big_change
    
    def _has_specifics(self, question):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏"""
        specifics = ['–∫—Ç–æ', '—á—Ç–æ', '–∫–æ–≥–¥–∞', '–∫–∞–∫–æ–π', '–∫–∞–∫–∞—è', '—Å–∫–æ–ª—å–∫–æ', '–≥–¥–µ']
        has_some_specifics = any(word in question for word in specifics)
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –≥–ª–∞–≥–æ–ª—ã –¥–µ–π—Å—Ç–≤–∏—è - —Ç–æ–∂–µ –æ–∫
        action_verbs = ['–≤–µ—Ä–Ω—É—Ç', '–ø–æ–ª—É—á—É', '–≤—Å—Ç—Ä–µ—á—É', '—É—Å—Ç—Ä–æ—é—Å—å', '–∫—É–ø–ª—é', '–ø—Ä–æ–¥–∞–º']
        has_actions = any(verb in question for verb in action_verbs)
        
        return has_some_specifics or has_actions
    
    def _is_too_passive(self, question):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Å—Å–∏–≤–Ω—É—é –ø–æ–∑–∏—Ü–∏—é"""
        passive_patterns = [
            '–ø–æ–¥–∞—Ä—è—Ç –º–Ω–µ', '–¥–æ—Å—Ç–∞–Ω–µ—Ç—Å—è –º–Ω–µ', '—É–ø–∞–¥–µ—Ç —Å –Ω–µ–±–∞', 
            '–≤—ã–∏–≥—Ä–∞—é –±–µ–∑', '–ø–æ–ª—É—á—É –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫', '–º–Ω–µ –¥–æ–ª–∂–Ω—ã'
        ]
        return any(pattern in question for pattern in passive_patterns)
    
    def _violates_scale(self, question):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏"""
        unrealistic = [
            '–ø–æ–¥–∞—Ä—è—Ç –∫–≤–∞—Ä—Ç–∏—Ä—É', '–ø–æ–ª—É—á—É –º–∏–ª–ª–∏–æ–Ω', '—Å—Ç–∞–Ω—É –∑–Ω–∞–º–µ–Ω–∏—Ç—ã–º',
            '–≤—Å—Ç—Ä–µ—á—É –ø—Ä–∏–Ω—Ü–∞', '–Ω–∞–π–¥—É –∫–ª–∞–¥', '–ø–µ—Ä–µ–µ–¥—É –≤ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω—É'
        ]
        urgent = ['—Å–µ–≥–æ–¥–Ω—è', '–∑–∞–≤—Ç—Ä–∞', '–Ω–∞ –Ω–µ–¥–µ–ª–µ']
        
        has_unrealistic = any(word in question for word in unrealistic)
        has_urgent = any(word in question for word in urgent)
        
        return has_unrealistic and has_urgent
    
    def suggest_better_question(self, original_question):
        """–ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —É–ª—É—á—à–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        question_lower = original_question.lower()
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è —Ç–æ—á–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏
        if any(word in question_lower for word in ['–∑–∞–º—É–∂', '–∂–µ–Ω–∏—Ç—å', '–±—Ä–∞–∫', '–æ—Ç–Ω–æ—à–µ–Ω']):
            return "¬´–ï—Å—Ç—å –ª–∏ —É –º–µ–Ω—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π —Å [–∏–º—è] –≤ –±–ª–∏–∂–∞–π—à–∏–µ 3 –º–µ—Å—è—Ü–∞?¬ª"
        
        elif any(word in question_lower for word in ['–¥–µ–Ω—å–≥', '—Ñ–∏–Ω–∞–Ω—Å', '–¥–µ–Ω–µ–≥', '–º–∏–ª–ª–∏–æ–Ω']):
            return "¬´–ü–æ–ª—É—á—É –ª–∏ —è –æ–∂–∏–¥–∞–µ–º—ã–µ –¥–µ–Ω—å–≥–∏ [–∑–∞—Ä–ø–ª–∞—Ç–∞/–¥–æ–ª–≥/–ø—Ä–µ–º–∏—è] –¥–æ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞]?¬ª"
        
        elif any(word in question_lower for word in ['—Ä–∞–±–æ—Ç', '–∫–∞—Ä—å–µ—Ä', '–¥–æ–ª–∂–Ω–æ—Å—Ç']):
            return "¬´–£—Å—Ç—Ä–æ—é—Å—å –ª–∏ —è –Ω–∞ —Ä–∞–±–æ—Ç—É [–Ω–∞–∑–≤–∞–Ω–∏–µ] –≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞?¬ª"
        
        elif any(word in question_lower for word in ['–∑–¥–æ—Ä–æ–≤', '–±–æ–ª–µ–∑', '–ª–µ—á–µ–Ω']):
            return "¬´–£–ª—É—á—à–∏—Ç—Å—è –ª–∏ –º–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ/—Å–æ—Å—Ç–æ—è–Ω–∏–µ [–∫–æ–≥–æ] –ø–æ—Å–ª–µ [–ª–µ—á–µ–Ω–∏–µ]?¬ª"
        
        elif any(word in question_lower for word in ['–ø–æ–µ–∑–¥', '–ø—É—Ç–µ—à–µ—Å—Ç–≤', '–ø–µ—Ä–µ–µ–∑–¥']):
            return "¬´–°—Ç–æ–∏—Ç –ª–∏ –º–Ω–µ –µ—Ö–∞—Ç—å –≤ [–º–µ—Å—Ç–æ] –≤ [–¥–∞—Ç–∞]? –ë—É–¥–µ—Ç –ª–∏ –ø–æ–µ–∑–¥–∫–∞ —É—Å–ø–µ—à–Ω–æ–π?¬ª"
        
        else:
            # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
            templates = [
                "¬´–í–µ—Ä–Ω—É—Ç –ª–∏ –º–Ω–µ [—á—Ç–æ] –¥–æ [–∫–æ–≥–¥–∞]?¬ª",
                "¬´–í—Å—Ç—Ä–µ—á—É –ª–∏ —è [–∫–æ–≥–æ] –Ω–∞ [–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ]?¬ª", 
                "¬´–°—Ç–æ–∏—Ç –ª–∏ –º–Ω–µ [–¥–µ–π—Å—Ç–≤–∏–µ] –≤ —Ç–µ—á–µ–Ω–∏–µ [—Å—Ä–æ–∫]?¬ª",
                "¬´–î–æ—Å—Ç–∏–≥–Ω—É –ª–∏ —è [—Ü–µ–ª—å] –∫ [–¥–∞—Ç–∞]?¬ª"
            ]
            return random.choice(templates)

class HoraryBrain:
    def __init__(self):
        self.experience = 0
        self.reality_checker = RealityChecker()
    
    def analyze_question_legitimacy(self, question):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–µ–≥–∏—Ç–∏–º–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∞ –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º"""
        is_valid, message = self.reality_checker.check_reality(question)
        
        if not is_valid:
            suggestion = self.reality_checker.suggest_better_question(question)
            full_message = f"""üéØ –ó–ê–ü–†–û–° –ù–ê –£–¢–û–ß–ù–ï–ù–ò–ï

–í–∞—à –≤–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. 
–•–æ—Ä–∞—Ä–Ω–∞—è –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ö–û–ù–ö–†–ï–¢–ù–´–ú–ò —Å–∏—Ç—É–∞—Ü–∏—è–º–∏.

üí° **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ç–∞–∫:**
¬´{suggestion}¬ª

‚ú® **–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:**
‚Ä¢ ¬´–í–µ—Ä–Ω—É—Ç –ª–∏ –º–Ω–µ –¥–æ–ª–≥ 5000 —Ä—É–± –¥–æ –ø—è—Ç–Ω–∏—Ü—ã?¬ª
‚Ä¢ ¬´–í—Å—Ç—Ä–µ—á—É –ª–∏ —è —Å–≤–æ—é —Å—É–¥—å–±—É –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫–µ –≤ —Å—É–±–±–æ—Ç—É?¬ª  
‚Ä¢ ¬´–ü–æ–ª—É—á—É –ª–∏ —è —Ä–∞–±–æ—Ç—É –≤ –∫–æ–º–ø–∞–Ω–∏–∏ X –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞?¬ª
‚Ä¢ ¬´–°—Ç–æ–∏—Ç –ª–∏ –º–Ω–µ –ø–æ–∫—É–ø–∞—Ç—å —ç—Ç—É –∫–≤–∞—Ä—Ç–∏—Ä—É?¬ª

–ß–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ –≤–æ–ø—Ä–æ—Å - —Ç–µ–º —Ç–æ—á–Ω–µ–µ –æ—Ç–≤–µ—Ç!"""
            return False, full_message
        
        return True, "–í–æ–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç –∫ –∞–Ω–∞–ª–∏–∑—É"
    
    def analyze_question_type(self, question):
        question_lower = question.lower()
        if any(word in question_lower for word in ['–¥–µ–Ω—å–≥', '—Ñ–∏–Ω–∞–Ω—Å', '–¥–µ–Ω–µ–≥', '—Ä—É–±–ª', '–µ–≤—Ä–æ', '–¥–æ–ª–ª–∞—Ä']):
            return "–§–ò–ù–ê–ù–°–´", "üí∞"
        elif any(word in question_lower for word in ['–ª—é–±–∏—Ç', '—Å–∫—É—á', '–æ—Ç–Ω–æ—à–µ–Ω', '–±—Ä–∞–∫', '–∑–∞–º—É–∂', '–≤—Å—Ç—Ä–µ—á']):
            return "–û–¢–ù–û–®–ï–ù–ò–Ø", "üíñ" 
        elif any(word in question_lower for word in ['—Ä–∞–±–æ—Ç', '–∫–∞—Ä—å–µ—Ä', '–¥–æ–ª–∂–Ω–æ—Å—Ç', '–±–∏–∑–Ω–µ—Å', '–ø—Ä–æ–µ–∫—Ç']):
            return "–ö–ê–†–¨–ï–†–ê", "üöÄ"
        elif any(word in question_lower for word in ['–∑–¥–æ—Ä–æ–≤', '–±–æ–ª–µ–∑', '–ª–µ—á–µ–Ω', '–≤—Ä–∞—á', '–±–æ–ª—å–Ω–∏—Ü']):
            return "–ó–î–û–†–û–í–¨–ï", "üè•"
        elif any(word in question_lower for word in ['–ø–æ–µ–∑–¥', '–ø—É—Ç–µ—à–µ—Å—Ç–≤', '–ø–µ—Ä–µ–µ–∑–¥', '–æ—Ç–ø—É—Å–∫']):
            return "–ü–£–¢–ï–®–ï–°–¢–í–ò–Ø", "‚úàÔ∏è"
        else:
            return "–û–ë–©–ò–ô", "üîÆ"
    
    def make_decision(self, moon_sign, sun_sign, question_type):
        """–£–ú–ù–´–ï –û–ë–û–°–ù–û–í–ê–ù–ò–Ø —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞ –∏ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤"""
        
        # –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞
        favorable_signs = ['–¢–µ–ª–µ—Ü', '–†–∞–∫', '–í–µ—Å—ã', '–°—Ç—Ä–µ–ª–µ—Ü']
        challenging_signs = ['–û–≤–µ–Ω', '–ë–ª–∏–∑–Ω–µ—Ü—ã', '–î–µ–≤–∞', '–ö–æ–∑–µ—Ä–æ–≥']
        
        moon_favorable = moon_sign in favorable_signs
        sun_favorable = sun_sign in favorable_signs
        
        # –ë–ê–ó–û–í–û–ï –†–ï–®–ï–ù–ò–ï
        if moon_favorable and sun_favorable:
            verdict = "–î–ê ‚úÖ"
            base_reason = "–ò –õ—É–Ω–∞, –∏ –°–æ–ª–Ω—Ü–µ –≤ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã—Ö –∑–Ω–∞–∫–∞—Ö - –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π!"
        elif moon_favorable:
            verdict = "–î–ê, –ù–û... ‚ö†Ô∏è" 
            base_reason = "–õ—É–Ω–∞ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç—Å—Ç–≤—É–µ—Ç, –Ω–æ –°–æ–ª–Ω—Ü–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏."
        elif sun_favorable:
            verdict = "–í–û–ó–ú–û–ñ–ù–û ü§î"
            base_reason = "–°–æ–ª–Ω—Ü–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç, –Ω–æ –õ—É–Ω–∞ —Å–æ–≤–µ—Ç—É–µ—Ç –ø–æ–¥–æ–∂–¥–∞—Ç—å."
        else:
            verdict = "–ù–ï–¢ ‚ùå"
            base_reason = "–°–µ–π—á–∞—Å –Ω–µ–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ–µ –≤—Ä–µ–º—è - –ª—É—á—à–µ –æ—Ç–ª–æ–∂–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è."
        
        # –°–ü–ï–¶–ò–§–ò–ß–ï–°–ö–ò–ï –ü–û–Ø–°–ù–ï–ù–ò–Ø –ü–û –¢–ò–ü–£ –í–û–ü–†–û–°–ê
        detailed_reasoning = self._get_detailed_reasoning(question_type, moon_sign, sun_sign, verdict)
        
        return verdict, f"{base_reason} {detailed_reasoning}"
    
    def _get_detailed_reasoning(self, question_type, moon_sign, sun_sign, verdict):
        """–î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤"""
        
        if question_type == "–û–¢–ù–û–®–ï–ù–ò–Ø":
            if "–î–ê" in verdict:
                return "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–∞. –ü—Ä–æ—è–≤–ª—è–π—Ç–µ –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å –≤ –æ–±—â–µ–Ω–∏–∏. –≠—Ç–æ —Ö–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Å–µ—Ä–¥–µ—á–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –∏ —Å–±–ª–∏–∂–µ–Ω–∏—è."
            else:
                return "–°–µ–π—á–∞—Å –≤–æ–∑–º–æ–∂–Ω—ã –Ω–µ–¥–æ–ø–æ–Ω–∏–º–∞–Ω–∏—è. –î–∞–π—Ç–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –≤—Ä–µ–º—è —Å–æ–∑—Ä–µ—Ç—å. –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è - –∏—Å—Ç–∏–Ω–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞ –ø—Ä–æ—è–≤—è—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º."
        
        elif question_type == "–§–ò–ù–ê–ù–°–´":
            if "–î–ê" in verdict:
                return "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã. –°–º–µ–ª–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ä–∞–∑—É–º–Ω—É—é –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å."
            else: 
                return "–° —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –ª—É—á—à–µ –ø–æ–≤—Ä–µ–º–µ–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤—Å–µ –¥–µ—Ç–∞–ª–∏, –∏–∑–±–µ–≥–∞–π—Ç–µ —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã—Ö —Ç—Ä–∞—Ç –∏ —Ä–∏—Å–∫–æ–≤—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π."
        
        elif question_type == "–ö–ê–†–¨–ï–†–ê":
            if "–î–ê" in verdict:
                return "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç –≤–µ—Ä–æ—è—Ç–µ–Ω. –ü—Ä–æ—è–≤–ª—è–π—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –Ω–∞–≤—ã–∫–∏. –í–∞—à–∏ —É—Å–∏–ª–∏—è –±—É–¥—É—Ç –∑–∞–º–µ—á–µ–Ω—ã —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º."
            else:
                return "–ö–∞—Ä—å–µ—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª—É—á—à–µ –æ—Ç–ª–æ–∂–∏—Ç—å. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á–∞—Ö –∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ - –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Å–∫–∞—á–∫–∞ –µ—â—ë –≤–ø–µ—Ä–µ–¥–∏."
        
        elif question_type == "–ó–î–û–†–û–í–¨–ï":
            if "–î–ê" in verdict:
                return "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–∞. –°–ª–µ–¥—É–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –≤—Ä–∞—á–µ–π, –æ—Ä–≥–∞–Ω–∏–∑–º —Ö–æ—Ä–æ—à–æ –æ—Ç–∫–ª–∏–∫–Ω–µ—Ç—Å—è –Ω–∞ –ª–µ—á–µ–Ω–∏–µ."
            else:
                return "–ü–µ—Ä–∏–æ–¥ —Ç—Ä–µ–±—É–µ—Ç –æ—Å–æ–±–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è –∫ –∑–¥–æ—Ä–æ–≤—å—é. –ù–µ –ø—Ä–µ–Ω–µ–±—Ä–µ–≥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–æ–π –∏ —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è–º–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤."
        
        elif question_type == "–ü–£–¢–ï–®–ï–°–¢–í–ò–Ø":
            if "–î–ê" in verdict:
                return "–ü–æ–µ–∑–¥–∫–∞ –æ–±–µ—â–∞–µ—Ç –±—ã—Ç—å —É—Å–ø–µ—à–Ω–æ–π. –ù–æ–≤—ã–µ –º–µ—Å—Ç–∞ –ø—Ä–∏–Ω–µ—Å—É—Ç –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞. –°–º–µ–ª–æ —Å–æ–±–∏—Ä–∞–π—Ç–µ —á–µ–º–æ–¥–∞–Ω—ã!"
            else:
                return "–° –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ–º –ª—É—á—à–µ –ø–æ–≤—Ä–µ–º–µ–Ω–∏—Ç—å. –í–æ–∑–º–æ–∂–Ω—ã –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏. –ï—Å–ª–∏ –ø–æ–µ–∑–¥–∫–∞ –Ω–µ–∏–∑–±–µ–∂–Ω–∞ - —Ç—â–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫–æ –≤—Å–µ–º —Å—Ü–µ–Ω–∞—Ä–∏—è–º."
        
        else:  # –û–ë–©–ò–ô
            if "–î–ê" in verdict:
                return "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–∏–º –ø–ª–∞–Ω–∞–º. –î–µ–π—Å—Ç–≤—É–π—Ç–µ —É–≤–µ—Ä–µ–Ω–Ω–æ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –≤ –ø—Ä–∏–Ω—è—Ç–∏–∏ —Ä–µ—à–µ–Ω–∏–π!"
            else:
                return "–í—Å–µ–ª–µ–Ω–Ω–∞—è —Å–æ–≤–µ—Ç—É–µ—Ç –Ω–∞–±—Ä–∞—Ç—å—Å—è —Ç–µ—Ä–ø–µ–Ω–∏—è. –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –µ—â—ë –≤–ø–µ—Ä–µ–¥–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –ø–∞—É–∑—É –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."
    
    def generate_strategy(self, verdict, moon_sign, question_type):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–µ–π—Å—Ç–≤–∏–π"""
        if "–î–ê" in verdict:
            strategies = [
                "–î–µ–π—Å—Ç–≤—É–π—Ç–µ —É–≤–µ—Ä–µ–Ω–Ω–æ - –∑–≤—ë–∑–¥—ã –Ω–∞ –≤–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ!",
                "–°–º–µ–ª–æ –≤–æ–ø–ª–æ—â–∞–π—Ç–µ –ø–ª–∞–Ω—ã –≤ –∂–∏–∑–Ω—å - –∫–æ—Å–º–∏—á–µ—Å–∫–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –≤–∞—Å!",
                "–≠—Ç–æ –∏–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —à–∞–Ω—Å!",
                "–ü—Ä–æ—è–≤–ª—è–π—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É - –≤—Å–µ–ª–µ–Ω–Ω–∞—è —Ä–∞—Å—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å—ë –ø–æ —Å–≤–æ–∏–º –º–µ—Å—Ç–∞–º!"
            ]
        else:
            strategies = [
                "–ü—Ä–æ—è–≤–∏—Ç–µ —Ç–µ—Ä–ø–µ–Ω–∏–µ - –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –≤–ø–µ—Ä–µ–¥–∏!",
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –ø–∞—É–∑—É –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è!",
                "–û—Ç–ª–æ–∂–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è - —Å–µ–π—á–∞—Å –≤–∞–∂–Ω–µ–µ –Ω–∞–±–ª—é–¥–∞—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å!",
                "–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–∞–±–æ—Ç–µ - –≤–Ω–µ—à–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏–¥—É—Ç –ø–æ–∑–∂–µ!"
            ]
        return random.choice(strategies)

bot_brain = HoraryBrain()

def get_moscow_time():
    utc_time = datetime.utcnow()
    moscow_time = utc_time + timedelta(hours=3)
    return moscow_time.strftime('%H:%M, %d.%m.%Y')

def get_russian_zodiac(eng_sign):
    zodiac_map = {
        'Aries': '–û–≤–µ–Ω', 'Taurus': '–¢–µ–ª–µ—Ü', 'Gemini': '–ë–ª–∏–∑–Ω–µ—Ü—ã',
        'Cancer': '–†–∞–∫', 'Leo': '–õ–µ–≤', 'Virgo': '–î–µ–≤–∞',
        'Libra': '–í–µ—Å—ã', 'Scorpio': '–°–∫–æ—Ä–ø–∏–æ–Ω', 'Sagittarius': '–°—Ç—Ä–µ–ª–µ—Ü',
        'Capricorn': '–ö–æ–∑–µ—Ä–æ–≥', 'Aquarius': '–í–æ–¥–æ–ª–µ–π', 'Pisces': '–†—ã–±—ã'
    }
    return zodiac_map.get(eng_sign, eng_sign)

# –û–ë–†–ê–ë–û–¢–ö–ê –ì–†–£–ü–ü
@bot.message_handler(chat_types=['group', 'supergroup'])
def handle_group_message(message):
    if message.text and ('@HoraryEmperorBot' in message.text):
        question = message.text.replace('@HoraryEmperorBot', '').strip()
        if question:
            # –ü–†–û–í–ï–†–Ø–ï–ú –õ–ï–ì–ò–¢–ò–ú–ù–û–°–¢–¨
            is_legitimate, legitimacy_message = bot_brain.analyze_question_legitimacy(question)
            
            if not is_legitimate:
                bot.reply_to(message, legitimacy_message)
                return
            
            # –ï–°–õ–ò –í–û–ü–†–û–° –õ–ï–ì–ò–¢–ò–ú–ï–ù - –ê–ù–ê–õ–ò–ó
            analysis = get_detailed_analysis(question)
            bot.reply_to(message, analysis)

# –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø
@bot.message_handler(func=lambda message: True)
def handle_message(message):
    if message.text.startswith('/'):
        if message.text == '/start':
            start_text = """
üîÆ –Ø ‚Äî –£–ú–ù–´–ô –•–æ—Ä–∞—Ä–Ω—ã–π –ò–º–ø–µ—Ä–∞—Ç–æ—Ä!

–Ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –†–ï–ê–õ–¨–ù–´–ï –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏:
‚Ä¢ üí∞ –§–∏–Ω–∞–Ω—Å—ã –∏ –∫–∞—Ä—å–µ—Ä–∞
‚Ä¢ üíñ –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –±—Ä–∞–∫  
‚Ä¢ üè• –ó–¥–æ—Ä–æ–≤—å–µ –∏ —Ä–µ—à–µ–Ω–∏—è
‚Ä¢ üöÄ –ü–ª–∞–Ω—ã –∏ –ø—Ä–æ–µ–∫—Ç—ã
‚Ä¢ ‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏ –ø–µ—Ä–µ–µ–∑–¥—ã

‚ùó –Ø –ù–ï –æ—Ç–≤–µ—á–∞—é –Ω–∞:
‚Ä¢ –ú–µ—Ç–µ–æ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –í–æ–ø—Ä–æ—Å—ã —Å –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –ª–æ–≥–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏  
‚Ä¢ –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ "—á—É–¥–µ—Å–∞ –±–µ–∑ —É—Å–∏–ª–∏–π"

–ó–∞–¥–∞–π—Ç–µ –û–°–ú–´–°–õ–ï–ù–ù–´–ô –≤–æ–ø—Ä–æ—Å –æ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏!
"""
            bot.reply_to(message, start_text)
        return
    
    try:
        # –ü–†–û–í–ï–†–Ø–ï–ú –õ–ï–ì–ò–¢–ò–ú–ù–û–°–¢–¨ –í–û–ü–†–û–°–ê
        is_legitimate, legitimacy_message = bot_brain.analyze_question_legitimacy(message.text)
        
        if not is_legitimate:
            bot.reply_to(message, legitimacy_message)
            return
        
        # –ï–°–õ–ò –í–û–ü–†–û–° –õ–ï–ì–ò–¢–ò–ú–ï–ù - –î–ï–õ–ê–ï–ú –ê–ù–ê–õ–ò–ó
        display_time = get_moscow_time()
        
        observer = ephem.Observer()
        observer.lat = '55.7558'
        observer.lon = '37.6173'
        
        moon = ephem.Moon()
        sun = ephem.Sun()
        moon.compute(observer)
        sun.compute(observer)
        
        moon_sign = get_russian_zodiac(ephem.constellation(moon)[1])
        sun_sign = get_russian_zodiac(ephem.constellation(sun)[1])
        
        question_type, emoji = bot_brain.analyze_question_type(message.text)
        verdict, reasoning = bot_brain.make_decision(moon_sign, sun_sign, question_type)
        strategy = bot_brain.generate_strategy(verdict, moon_sign, question_type)
        
        response = f"""
üîÆ –£–ú–ù–´–ô –•–û–†–ê–†–ù–´–ô –ê–ù–ê–õ–ò–ó
‚è∞ {display_time}, –ú–û–°–ö–í–ê

‚ùì –í–û–ü–†–û–°: {message.text}
üéØ –¢–ò–ü: {question_type} {emoji}

üìä –ö–ê–†–¢–ê:
‚Ä¢ üåô –õ—É–Ω–∞: {moon_sign}
‚Ä¢ ‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ: {sun_sign}

‚ö° –í–ï–†–î–ò–ö–¢: {verdict}
üí° –û–ë–û–°–ù–û–í–ê–ù–ò–ï: {reasoning}

üí´ –°–¢–†–ê–¢–ï–ì–ò–Ø: {strategy}

‚úÖ –í–æ–ø—Ä–æ—Å –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å
ü§ñ –£—Ä–æ–≤–µ–Ω—å –∞–Ω–∞–ª–∏–∑–∞: {bot_brain.experience + 1}
"""
        bot.reply_to(message, response)
        bot_brain.experience += 1
        
    except Exception as e:
        bot.reply_to(message, f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}")

def get_detailed_analysis(question):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö"""
    display_time = get_moscow_time()
    
    observer = ephem.Observer()
    observer.lat = '55.7558'
    observer.lon = '37.6173'
    
    moon = ephem.Moon()
    sun = ephem.Sun()
    moon.compute(observer)
    sun.compute(observer)
    
    moon_sign = get_russian_zodiac(ephem.constellation(moon)[1])
    sun_sign = get_russian_zodiac(ephem.constellation(sun)[1])
    
    question_type, emoji = bot_brain.analyze_question_type(question)
    verdict, reasoning = bot_brain.make_decision(moon_sign, sun_sign, question_type)
    strategy = bot_brain.generate_strategy(verdict, moon_sign, question_type)
    
    return f"""
üîÆ –ì–†–£–ü–ü–û–í–û–ô –ê–ù–ê–õ–ò–ó
‚è∞ {display_time}

‚ùì –í–û–ü–†–û–°: {question}
üéØ –¢–ò–ü: {question_type} {emoji}

üìä –ö–ê–†–¢–ê:
‚Ä¢ üåô –õ—É–Ω–∞: {moon_sign}
‚Ä¢ ‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ: {sun_sign}

‚ö° –í–ï–†–î–ò–ö–¢: {verdict}
üí° –û–ë–û–°–ù–û–í–ê–ù–ò–ï: {reasoning}

üí´ –°–¢–†–ê–¢–ï–ì–ò–Ø: {strategy}

‚ú® @HoraryEmperorBot
"""

print("üîÑ –£–ú–ù–´–ô –±–æ—Ç —Å –î–ï–¢–ï–ö–¢–û–†–û–ú –†–ï–ê–õ–¨–ù–û–°–¢–ò –∑–∞–ø—É—â–µ–Ω...")
while True:
    try:
        bot.polling(none_stop=True, interval=1)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")
        time.sleep(5)
