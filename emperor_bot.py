import telebot
import time
import random
import json
import os
from datetime import datetime, timedelta, timezone
from flask import Flask
import threading
import requests

print("üåå –ó–∞–ø—É—Å–∫–∞—é –£–°–¢–û–ô–ß–ò–í–û–ì–û –•–æ—Ä–∞—Ä–Ω–æ–≥–æ –ò–º–ø–µ—Ä–∞—Ç–æ—Ä–∞...")

# –ü—Ä–æ—Å—Ç–æ–π Flask –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è
app = Flask(__name__)
@app.route('/')
def home():
    return "üîÑ –£—Å—Ç–æ–π—á–∏–≤—ã–π –ò–º–ø–µ—Ä–∞—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!", 200

def run_flask():
    app.run(host='0.0.0.0', port=5000, debug=False)

# –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
flask_thread = threading.Thread(target=run_flask, daemon=True)
flask_thread.start()

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞
BOT_TOKEN = "7166686748:AAFnyfjq5UsunijP_p8HQiYeKHh3qoAM5RA"

# –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ–º –≤–µ–±—Ö—É–∫ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –±–æ—Ç–∞ [citation:1][citation:8]
try:
    response = requests.get(f"https://api.telegram.org/bot{BOT_TOKEN}/deleteWebhook")
    print("‚úÖ –í–µ–±—Ö—É–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω—ã")
    time.sleep(3)  # –î–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
except Exception as e:
    print(f"‚ÑπÔ∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–µ–±—Ö—É–∫–æ–≤: {e}")

# –¢–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ–º –±–æ—Ç–∞
bot = telebot.TeleBot(BOT_TOKEN)

class StableHoraryEmperor:
    def __init__(self):
        print("üîÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –ò–º–ø–µ—Ä–∞—Ç–æ—Ä–∞...")
        self.learning_file = 'emperor_memory.json'
        self.load_memory()
    
    def load_memory(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞–º—è—Ç—å"""
        try:
            if os.path.exists(self.learning_file):
                with open(self.learning_file, 'r', encoding='utf-8') as f:
                    self.memory = json.load(f)
                print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.memory.get('patterns', []))} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤")
            else:
                self.memory = {'patterns': [], 'user_preferences': {}}
        except:
            self.memory = {'patterns': [], 'user_preferences': {}}
    
    def save_memory(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞–º—è—Ç—å"""
        try:
            with open(self.learning_file, 'w', encoding='utf-8') as f:
                json.dump(self.memory, f, ensure_ascii=False, indent=2)
        except:
            pass
    
    def learn_interaction(self, question, response_type, user_id):
        """–£—á–∏–º—Å—è –Ω–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è—Ö"""
        pattern = {
            'question': question.lower(),
            'response_type': response_type,
            'timestamp': datetime.now().isoformat(),
            'user_id': user_id
        }
        self.memory['patterns'].append(pattern)
        if len(self.memory['patterns']) > 1000:
            self.memory['patterns'] = self.memory['patterns'][-1000:]
        self.save_memory()

    def get_intelligent_greeting(self):
        return random.choice([
            "üåå *–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, –ò—Å–∫–∞—Ç–µ–ª—å!* –Ø —Å—Ç–∞–Ω–æ–≤–ª—é—Å—å –º—É–¥—Ä–µ–µ —Å –∫–∞–∂–¥—ã–º —Ç–≤–æ–∏–º –≤–æ–ø—Ä–æ—Å–æ–º...",
            "‚ú® *–ü—Ä–µ–¥ –ª–∏–∫–æ–º –í–µ—á–Ω–æ—Å—Ç–∏ —Å–∫–ª–æ–Ω–∏—Å—å!* –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å - –∏ —è –æ—Ç–∫—Ä–æ—é —Ç–∞–π–Ω—ã –∑–≤–µ–∑–¥!",
            "üîÆ *–í —á–∞—Å, –∫–æ–≥–¥–∞ –∑–≤—ë–∑–¥—ã —à–µ–ø—á—É—Ç,* —è –≤–Ω–∏–º–∞—é —Ç–≤–æ–∏–º —Å—Ç—Ä–µ–º–ª–µ–Ω–∏—è–º...",
        ])

    def analyze_question_intent(self, question):
        """–£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞"""
        q = question.lower()
        
        if any(word in q for word in ['–¥–µ–Ω—å', '—Å–µ–≥–æ–¥–Ω—è', '–∑–∞–≤—Ç—Ä–∞', '–Ω–µ–¥–µ–ª']):
            return "day_forecast"
        elif any(word in q for word in ['–ª—é–±–æ–≤', '–æ—Ç–Ω–æ—à–µ–Ω', '—á—É–≤—Å—Ç–≤', '–ø–∞—Ä–µ–Ω—å', '–º—É–∂—á–∏–Ω']):
            if '–¥–æ –∫–æ–Ω—Ü–∞ –Ω–æ—è–±—Ä—è' in q: return "love_november"
            elif '–¥–æ –∫–æ–Ω—Ü–∞ –≥–æ–¥–∞' in q: return "love_year_end"
            else: return "love_general"
        elif any(word in q for word in ['–¥–µ–Ω—å–≥', '—Ñ–∏–Ω–∞–Ω—Å', '–¥–µ–Ω–µ–≥']):
            if '–ø–µ—Ä–µ–µ–∑–¥' in q: return "money_travel"
            else: return "money_general"
        elif any(word in q for word in ['—Ä–∞–±–æ—Ç', '–∫–∞—Ä—å–µ—Ä', '–±–∏–∑–Ω–µ—Å']):
            return "career"
        elif any(word in q for word in ['–∑–¥–æ—Ä–æ–≤', '–±–æ–ª–µ–∑']):
            return "health"
        else:
            return "deep_general"

    def generate_profound_analysis(self, question, intent):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ì–õ–£–ë–û–ö–û–ì–û –∞–Ω–∞–ª–∏–∑–∞"""
        current_time = datetime.now(timezone.utc) + timedelta(hours=3)
        time_str = current_time.strftime('%H:%M, %d %B %Y')
        
        if intent == "day_forecast":
            return self._profound_day_analysis(question, time_str)
        elif intent == "love_november":
            return self._profound_love_november(question, time_str)
        elif intent == "love_year_end":
            return self._profound_love_yearend(question, time_str)
        elif intent == "love_general":
            return self._profound_love_general(question, time_str)
        elif intent == "money_travel":
            return self._profound_money_travel(question, time_str)
        else:
            return self._profound_general_analysis(question, time_str)

    def _profound_day_analysis(self, question, time_str):
        """–ì–õ–£–ë–û–ö–ò–ô –∞–Ω–∞–ª–∏–∑ –¥–Ω—è"""
        analysis = f"""
*üåå –î–ï–¢–ê–õ–¨–ù–´–ô –•–û–†–ê–†–ù–´–ô –ê–ù–ê–õ–ò–ó –î–ù–Ø*

*–í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞:* {time_str}
*–í–æ–ø—Ä–æ—Å:* ¬´{question}¬ª

---

*ü™ê –¢–ï–ö–£–©–ê–Ø –ö–û–°–ú–ò–ß–ï–°–ö–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø:*

‚Ä¢ *–°–æ–ª–Ω—Ü–µ –≤ –°–∫–æ—Ä–ø–∏–æ–Ω–µ* (12¬∞) - —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
‚Ä¢ *–õ—É–Ω–∞ –≤ –¢–µ–ª—å—Ü–µ* (8¬∞) - —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ —á—É–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
‚Ä¢ *–ú–µ—Ä–∫—É—Ä–∏–π –≤ –°—Ç—Ä–µ–ª—å—Ü–µ* (5¬∞) - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–æ–∑–Ω–∞–Ω–∏—è
‚Ä¢ *–í–µ–Ω–µ—Ä–∞ –≤ –í–µ—Å–∞—Ö* (22¬∞) - –≥–∞—Ä–º–æ–Ω–∏—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö

---

*üîÆ –î–ï–¢–ê–õ–¨–ù–´–ô –ü–†–û–ì–ù–û–ó –ü–û –ë–õ–û–ö–ê–ú:*

*üåà –õ–ò–ß–ù–´–ï –û–¢–ù–û–®–ï–ù–ò–Ø:*
‚Ä¢ *–£—Ç—Ä–æ:* –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ –¥–ª—è —Å–µ—Ä–¥–µ—á–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
‚Ä¢ *–î–µ–Ω—å:* –ù–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ –≤–µ—Ä–æ—è—Ç–Ω—ã
‚Ä¢ *–í–µ—á–µ—Ä:* –ì–ª—É–±–æ–∫–∏–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–∑—Ä–µ–Ω–∏—è

*üí∞ –§–ò–ù–ê–ù–°–´ –ò –†–ï–°–£–†–°–´:*
‚Ä¢ *–≠–Ω–µ—Ä–≥–∏—è:* –°—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º —Ä–æ—Å—Ç–∞
‚Ä¢ *–†–∏—Å–∫–∏:* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ, –∑–≤–µ–∑–¥—ã –±–ª–∞–≥–æ–≤–æ–ª—è—Ç
‚Ä¢ *–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:* –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è

*üíº –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –°–§–ï–†–ê:*
‚Ä¢ *–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:* –ù–∞ –ø–∏–∫–µ —Å 11:00 –¥–æ 16:00
‚Ä¢ *–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ:* –ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã
‚Ä¢ *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:* –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω—ã
"""
        
        strategy = """*üéØ –°–¢–†–ê–¢–ï–ì–ò–Ø –ù–ê –î–ï–ù–¨:*

*üåÖ –£–¢–†–û (6:00-12:00):*
‚Ä¢ –†–µ—à–µ–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
‚Ä¢ –ì–∞—Ä–º–æ–Ω–∏—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ —Å –±–ª–∏–∑–∫–∏–º–∏
‚Ä¢ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–Ω—è —Å —É—á–µ—Ç–æ–º –∫–æ—Å–º–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Ç–º–æ–≤

*üèô –î–ï–ù–¨ (12:00-18:00):*
‚Ä¢ –ê–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
‚Ä¢ –ù–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
‚Ä¢ –¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏

*üåÉ –í–ï–ß–ï–† (18:00-24:00):*
‚Ä¢ –û—Ç–¥—ã—Ö –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏
‚Ä¢ –ì–ª—É–±–æ–∫–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –æ relationships
‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–º—É –¥–Ω—é

*üíé –ö–õ–Æ–ß–ï–í–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:*
‚Ä¢ –ù–æ—Å–∏—Ç–µ –±–∏—Ä—é–∑–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∏
‚Ä¢ –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —É—Ç—Ä–æ–º
‚Ä¢ –ë—É–¥—å—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º"""

        return analysis, strategy

    def _profound_love_november(self, question, time_str):
        """–ì–õ–£–ë–û–ö–ò–ô –∞–Ω–∞–ª–∏–∑ –ª—é–±–≤–∏ –¥–æ –∫–æ–Ω—Ü–∞ –Ω–æ—è–±—Ä—è"""
        analysis = f"""
*üíñ –î–ï–¢–ê–õ–¨–ù–´–ô –•–û–†–ê–†–ù–´–ô –ê–ù–ê–õ–ò–ó –õ–Æ–ë–í–ò –î–û –ö–û–ù–¶–ê –ù–û–Ø–ë–†–Ø*

*–í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞:* {time_str}
*–í–æ–ø—Ä–æ—Å:* ¬´{question}¬ª

---

*üåô –ù–û–Ø–ë–†–¨–°–ö–ò–ï –õ–Æ–ë–û–í–ù–´–ï –¶–ò–ö–õ–´:*

*‚ú® –ü–ï–†–í–ê–Ø –î–ï–ö–ê–î–ê (1-10 –Ω–æ—è–±—Ä—è):*
‚Ä¢ *–í–µ–Ω–µ—Ä–∞ –≤ –°–∫–æ—Ä–ø–∏–æ–Ω–µ* - –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏
‚Ä¢ *–õ—É–Ω–∞ –≤ –¢–µ–ª—å—Ü–µ* - –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
‚Ä¢ *–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã* –ø—Ä–µ–æ–±–ª–∞–¥–∞—é—Ç –Ω–∞–¥ –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω—ã–º–∏

*‚ú® –í–¢–û–†–ê–Ø –î–ï–ö–ê–î–ê (11-20 –Ω–æ—è–±—Ä—è):*
‚Ä¢ *–ú–µ—Ä–∫—É—Ä–∏–π —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–∏—Ä–µ–∫—Ç–Ω—ã–º* - —è—Å–Ω–æ—Å—Ç—å –≤ –æ–±—â–µ–Ω–∏–∏
‚Ä¢ *–ú–∞—Ä—Å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç 5-–π –¥–æ–º* - —Å–º–µ–ª–æ—Å—Ç—å –≤ –ª—é–±–æ–≤–Ω—ã—Ö –¥–µ–ª–∞—Ö
‚Ä¢ *–Æ–ø–∏—Ç–µ—Ä —Ä–∞—Å—à–∏—Ä—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏* –¥–ª—è –Ω–æ–≤—ã—Ö –∑–Ω–∞–∫–æ–º—Å—Ç–≤

*‚ú® –¢–†–ï–¢–¨–Ø –î–ï–ö–ê–î–ê (21-30 –Ω–æ—è–±—Ä—è):*
‚Ä¢ *–°–æ–ª–Ω—Ü–µ –≤ –°—Ç—Ä–µ–ª—å—Ü–µ* - –æ–ø—Ç–∏–º–∏–∑–º –∏ –Ω–æ–≤—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã
‚Ä¢ *–í–µ–Ω–µ—Ä–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –°—Ç—Ä–µ–ª—å—Ü–∞* - —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è
‚Ä¢ *–°–∞—Ç—É—Ä–Ω –¥–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å* —Å–µ—Ä—å–µ–∑–Ω—ã–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º

---

*üîÆ –í–ï–†–û–Ø–¢–ù–´–ï –°–û–ë–´–¢–ò–Ø:*

*–î–ª—è –æ–¥–∏–Ω–æ–∫–∏—Ö:*
‚Ä¢ –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º —á–µ—Ä–µ–∑ –¥—Ä—É–∑–µ–π (85%)
‚Ä¢ –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –≤ –Ω–µ–æ–±—ã—á–Ω–æ–º –º–µ—Å—Ç–µ (70%)
‚Ä¢ –ì–ª—É–±–æ–∫–æ–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (90%)

*–î–ª—è –≤—Å—Ç—Ä–µ—á–∞—é—â–∏—Ö—Å—è:*
‚Ä¢ –ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç–Ω–æ—à–µ–Ω–∏–π –Ω–∞ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (80%)
‚Ä¢ –í–∞–∂–Ω—ã–µ –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏—è –æ —á—É–≤—Å—Ç–≤–∞—Ö (95%)
‚Ä¢ –°–æ–≤–º–µ—Å—Ç–Ω—ã–µ –ø–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ (75%)

*üí´ –ê–°–¢–†–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:*
‚Ä¢ *–£—Ä–æ–≤–µ–Ω—å –≥–∞—Ä–º–æ–Ω–∏–∏:* 8/10 –±–∞–ª–ª–æ–≤
‚Ä¢ *–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—Å—Ç—Ä–µ—á–∏ –ª—é–±–≤–∏:* 85%
‚Ä¢ *–ü–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:* 15-25 –Ω–æ—è–±—Ä—è
"""
        
        strategy = """*üéØ –°–¢–†–ê–¢–ï–ì–ò–Ø –î–õ–Ø –õ–Æ–ë–í–ò –í –ù–û–Ø–ë–†–ï:*

*üíù –î–õ–Ø –ü–†–ò–í–õ–ï–ß–ï–ù–ò–Ø –õ–Æ–ë–í–ò:*
‚Ä¢ –ü–æ—Å–µ—â–∞–π—Ç–µ –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã
‚Ä¢ –ù–æ—Å–∏—Ç–µ —Ä–æ–∑–æ–≤—ã–π –∫–≤–∞—Ä—Ü –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è –ª—é–±–æ–≤–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏
‚Ä¢ –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏: ¬´–Ø –¥–æ—Å—Ç–æ–π–Ω–∞ –Ω–∞—Å—Ç–æ—è—â–µ–π –ª—é–±–≤–∏¬ª

*üîÑ –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–Ø –û–¢–ù–û–®–ï–ù–ò–ô:*
‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç–µ 3 –ø–æ–≤–æ–¥–∞ –¥–ª—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Ç–Ω–µ—Ä—É
‚Ä¢ –°–æ–≤–º–µ—Å—Ç–Ω–∞—è –º–µ–¥–∏—Ç–∞—Ü–∏—è –ø–æ –≤—Ç–æ—Ä–Ω–∏–∫–∞–º –∏ –ø—è—Ç–Ω–∏—Ü–∞–º
‚Ä¢ –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —É–∂–∏–Ω –ø—Ä–∏ —Å–≤–µ—á–∞—Ö 18 –Ω–æ—è–±—Ä—è

*üåü –û–°–û–ë–´–ï –î–ê–¢–´ –ù–û–Ø–ë–†–Ø:*
‚Ä¢ *7-10 –Ω–æ—è–±—Ä—è:* –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ –¥–ª—è –Ω–æ–≤—ã—Ö –∑–Ω–∞–∫–æ–º—Å—Ç–≤
‚Ä¢ *15-18 –Ω–æ—è–±—Ä—è:* –ü–µ—Ä–∏–æ–¥ –≥–ª—É–±–æ–∫–∏—Ö —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏–π
‚Ä¢ *22-25 –Ω–æ—è–±—Ä—è:* –í—Ä–µ–º—è –¥–ª—è —Å–µ—Ä—å–µ–∑–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
‚Ä¢ *28-30 –Ω–æ—è–±—Ä—è:* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å—É–¥—å–±–æ–Ω–æ—Å–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á"""

        return analysis, strategy

# –°–æ–∑–¥–∞–µ–º —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –∏–º–ø–µ—Ä–∞—Ç–æ—Ä–∞
emperor = StableHoraryEmperor()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(commands=['start', 'help', '–∏–º–ø–µ—Ä–∞—Ç–æ—Ä'])
def send_welcome(message):
    chat_type = "private" if message.chat.type == "private" else "group"
    
    greeting = emperor.get_intelligent_greeting()
    
    if chat_type == "private":
        response = f"""{greeting}

*–Ø —É—á—É—Å—å —Å –∫–∞–∂–¥—ã–º —Ç–≤–æ–∏–º –≤–æ–ø—Ä–æ—Å–æ–º –∏ —Å—Ç–∞–Ω–æ–≤–ª—é—Å—å –º—É–¥—Ä–µ–µ!* üß†

*–í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –æ–±—â–µ–Ω–∏—è:*
üí¨ *–ü—É–±–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å* - –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å
üîí *–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ* - —Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É –Ω–∞–º–∏

*–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω–∏ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã!*"""
    else:
        response = f"""{greeting}

*–Ø —Å—Ç–∞–Ω–æ–≤–ª—é—Å—å —É–º–Ω–µ–µ —Å –∫–∞–∂–¥—ã–º –≤–æ–ø—Ä–æ—Å–æ–º!* üß†

*–í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:*
üí¨ *–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –∑–¥–µ—Å—å* 
üîí *–ù–∞–ø–∏—à–∏ ¬´–õ–∏—á–Ω–æ–µ [–≤–æ–ø—Ä–æ—Å]¬ª* –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
üë§ *–ò–ª–∏ –ø–µ—Ä–µ–π–¥–∏ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è* –¥–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏

*–ß—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –≤ –õ–°:*
1. –ù–∞–∂–º–∏ –Ω–∞ –º–æ–µ –∏–º—è @HoraryEmperorBot  
2. –í—ã–±–µ—Ä–∏ ¬´–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ¬ª
3. –ó–∞–¥–∞–π –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø—Ä–∏–≤–∞—Ç–Ω–æ"""

    try:
        bot.reply_to(message, response, parse_mode='Markdown')
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

@bot.message_handler(func=lambda message: True)
def handle_all_messages(message):
    try:
        user_id = message.from_user.id
        text = message.text.strip()
        chat_type = "private" if message.chat.type == "private" else "group"
        
        print(f"üì® –í–æ–ø—Ä–æ—Å –æ—Ç {user_id}: {text}")

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –≥—Ä—É–ø–ø–µ [citation:6][citation:7]
        if chat_type in ['group', 'supergroup'] and text.lower().startswith('–ª–∏—á–Ω–æ–µ'):
            parts = text.split(' ', 1)
            if len(parts) > 1 and len(parts[1]) > 2:
                try:
                    # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
                    bot.send_chat_action(message.chat.id, 'typing')
                    time.sleep(1)
                    
                    intent = emperor.analyze_question_intent(parts[1])
                    analysis, strategy = emperor.generate_profound_analysis(parts[1], intent)
                    
                    # –£—á–∏–º—Å—è –Ω–∞ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ
                    emperor.learn_interaction(parts[1], intent, user_id)
                    
                    private_response = f"üîí *–ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–´–ô –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó*\n\n{analysis}\n\n*üéØ –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø:*\n{strategy}"
                    
                    bot.send_message(user_id, private_response, parse_mode='Markdown')
                    bot.reply_to(message, "‚úÖ *–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è!* üß†", parse_mode='Markdown')
                    return
                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞ –õ–°: {e}")
                    bot.reply_to(message, "üíå *–ù–∞–ø–∏—à–∏ –º–Ω–µ –≤ –õ–°:* @HoraryEmperorBot\n*–ò–ª–∏ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –∑–¥–µ—Å—å –±–µ–∑ –ª–∏—á–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π*", parse_mode='Markdown')
                    return
            else:
                bot.reply_to(message, "üîí *–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –ø–æ—Å–ª–µ '–õ–∏—á–Ω–æ–µ'*\n*–ü—Ä–∏–º–µ—Ä:* ¬´–õ–∏—á–Ω–æ–µ –ß—Ç–æ –º–µ–Ω—è –∂–¥–µ—Ç –≤ –ª—é–±–≤–∏?¬ª", parse_mode='Markdown')
                return

        # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        if text.lower() in ['–ø—Ä–∏–≤–µ—Ç', '–Ω–∞—á–∞—Ç—å', '–±–æ—Ç', '—Ö–æ—Ä–∞—Ä–Ω—ã–π']:
            greeting = emperor.get_intelligent_greeting()
            response = f"{greeting}\n\n–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å - –∏ —è –¥–∞–º —Ç–µ–±–µ –ì–õ–£–ë–û–ö–ò–ô –∞–Ω–∞–ª–∏–∑! üß†"
            bot.reply_to(message, response, parse_mode='Markdown')
            return

        # –û–±—ã—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å –ì–õ–£–ë–û–ö–ò–ú –∞–Ω–∞–ª–∏–∑–æ–º
        bot.send_chat_action(message.chat.id, 'typing')
        time.sleep(1)
        
        intent = emperor.analyze_question_intent(text)
        analysis, strategy = emperor.generate_profound_analysis(text, intent)
        
        # –£—á–∏–º—Å—è –Ω–∞ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ
        emperor.learn_interaction(text, intent, user_id)
        
        if chat_type == "private":
            full_response = f"{analysis}\n\n*üéØ –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø:*\n{strategy}\n\nüß† *–Ø —Å—Ç–∞–ª —É–º–Ω–µ–µ –±–ª–∞–≥–æ–¥–∞—Ä—è —Ç–≤–æ–µ–º—É –≤–æ–ø—Ä–æ—Å—É!*"
        else:
            full_response = f"{analysis}\n\n*üéØ –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø:*\n{strategy}\n\nüíå *–î–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏: ¬´–õ–∏—á–Ω–æ–µ [–≤–æ–ø—Ä–æ—Å]¬ª*\nüß† *–Ø —É—á—É—Å—å —Å –∫–∞–∂–¥—ã–º –≤–æ–ø—Ä–æ—Å–æ–º!*"
        
        bot.reply_to(message, full_response, parse_mode='Markdown')
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")
        try:
            bot.reply_to(message, "üîÆ *–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–º–µ—Ö–∏... –ù–æ —è —É—á—É—Å—å –Ω–∞ –æ—à–∏–±–∫–∞—Ö! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.* üß†", parse_mode='Markdown')
        except:
            pass

print("‚úÖ –£–°–¢–û–ô–ß–ò–í–´–ô –•–æ—Ä–∞—Ä–Ω—ã–π –ò–º–ø–µ—Ä–∞—Ç–æ—Ä –≥–æ—Ç–æ–≤!")
print("üåê Flask —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 5000")

# –£–°–¢–û–ô–ß–ò–í–´–ô –ó–ê–ü–£–°–ö –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ [citation:1][citation:5]
def run_stable_bot():
    attempt = 0
    while True:
        try:
            attempt += 1
            print(f"üîó –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è {attempt}...")
            
            # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º polling –≤–º–µ—Å—Ç–æ infinity_polling [citation:6][citation:7]
            bot.polling(
                none_stop=True,
                interval=2,
                timeout=60,
                long_polling_timeout=30
            )
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            wait_time = min(attempt * 10, 60)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
            print(f"üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ {wait_time} —Å–µ–∫—É–Ω–¥...")
            time.sleep(wait_time)

if __name__ == "__main__":
    run_stable_bot()
