import telebot
import time
import ephem
from datetime import datetime, timedelta

BOT_TOKEN = "7166686748:AAFnyfjq5UsunijP_p8HQiYeKHh3qoAM5RA"
bot = telebot.TeleBot(BOT_TOKEN)

# –ú–û–ó–ì –ë–û–¢–ê üß†
class HoraryBrain:
    def __init__(self):
        self.experience = 0
        
    def analyze_question_type(self, question):
        question_lower = question.lower()
        if any(word in question_lower for word in ['–¥–µ–Ω—å–≥', '—Ñ–∏–Ω–∞–Ω—Å', '–¥–µ–Ω–µ–≥', '–ø—Ä–∏–¥—É—Ç', '–ø–æ–ª—É—á—É']):
            return "–§–ò–ù–ê–ù–°–´", 2, "–í–µ–Ω–µ—Ä–∞"
        elif any(word in question_lower for word in ['–ª—é–±–∏—Ç', '—Å–∫—É—á', '–æ—Ç–Ω–æ—à–µ–Ω', '—á—É–≤—Å—Ç–≤', '–ª—é–±–æ–≤']):
            return "–û–¢–ù–û–®–ï–ù–ò–Ø", 7, "–í–µ–Ω–µ—Ä–∞" 
        elif any(word in question_lower for word in ['—Ä–∞–±–æ—Ç', '–∫–∞—Ä—å–µ—Ä', '–±–∏–∑–Ω–µ—Å', '–ø—Ä–æ–µ–∫—Ç']):
            return "–ö–ê–†–¨–ï–†–ê", 10, "–°–∞—Ç—É—Ä–Ω"
        elif any(word in question_lower for word in ['–∑–¥–æ—Ä–æ–≤', '–±–æ–ª–µ–∑', '—Å–∞–º–æ—á—É–≤—Å—Ç–≤']):
            return "–ó–î–û–†–û–í–¨–ï", 6, "–ú–∞—Ä—Å"
        else:
            return "–û–ë–©–ò–ô", 1, "–°–æ–ª–Ω—Ü–µ"
    
    def make_decision(self, moon_sign, venus_sign, question_type):
        # –£–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–∞–ª–ª–æ–≤
        good_signs = ['–¢–µ–ª–µ—Ü', '–†–∞–∫', '–í–µ—Å—ã', '–°—Ç—Ä–µ–ª–µ—Ü']
        
        score = 0
        if moon_sign in good_signs: score += 50
        if venus_sign in good_signs: score += 30
        if question_type == "–§–ò–ù–ê–ù–°–´": score += 20
        
        if score > 70:
            return "–î–ê ‚úÖ", "–í—ã—Å–æ–∫–∏–µ —à–∞–Ω—Å—ã –Ω–∞ —É—Å–ø–µ—Ö! –ó–≤–µ–∑–¥—ã –±–ª–∞–≥–æ–≤–æ–ª—è—Ç"
        elif score > 40:
            return "–í–û–ó–ú–û–ñ–ù–û ü§î", "–®–∞–Ω—Å—ã –µ—Å—Ç—å, –Ω–æ –Ω—É–∂–Ω—ã –≤–∞—à–∏ —É—Å–∏–ª–∏—è"
        else:
            return "–ù–ï–¢ ‚ùå", "–°–µ–π—á–∞—Å –Ω–µ –ª—É—á—à–µ–µ –≤—Ä–µ–º—è - –ø—Ä–æ—è–≤–∏—Ç–µ —Ç–µ—Ä–ø–µ–Ω–∏–µ"
    
    def generate_strategy(self, verdict, moon_sign, question_type):
        strategies = {
            "–§–ò–ù–ê–ù–°–´": {
                "–î–ê ‚úÖ": f"üí∞ –ü—Ä–∏ –õ—É–Ω–µ –≤ {moon_sign} - –ò–î–ï–ê–õ–¨–ù–û–ï –≤—Ä–µ–º—è –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π! –°–º–µ–ª–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ, –≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã, –∑–∞–∫–ª—é—á–∞–π—Ç–µ —Å–¥–µ–ª–∫–∏. –î–µ–Ω—å–≥–∏ —Ç–µ–∫—É—Ç –∫ –≤–∞–º —Ä–µ–∫–æ–π!",
                "–í–û–ó–ú–û–ñ–ù–û ü§î": f"üí∏ –ü—Ä–∏ –õ—É–Ω–µ –≤ {moon_sign} - –¥–µ–π—Å—Ç–≤—É–π—Ç–µ –û–°–¢–û–†–û–ñ–ù–û, –Ω–æ –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥–µ—Ç–∞–ª–∏, –Ω–µ —Ä–∏—Å–∫—É–π—Ç–µ –∫—Ä—É–ø–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏. –£—Å–ø–µ—Ö –≤–æ–∑–º–æ–∂–µ–Ω –ø—Ä–∏ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ.",
                "–ù–ï–¢ ‚ùå": f"üö´ –ü—Ä–∏ –õ—É–Ω–µ –≤ {moon_sign} - –û–¢–õ–û–ñ–ò–¢–ï —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –°–µ–π—á–∞—Å –≤—ã—Å–æ–∫–∏–µ —Ä–∏—Å–∫–∏ –ø–æ—Ç–µ—Ä—å. –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –Ω–∞—Å—Ç—É–ø–∏—Ç —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π."
            },
            "–û–¢–ù–û–®–ï–ù–ò–Ø": {
                "–î–ê ‚úÖ": f"üíñ –õ—É–Ω–∞ –≤ {moon_sign} —Å–æ–∑–¥–∞–µ—Ç –ú–ê–ì–ò–Æ –ü–†–ò–¢–Ø–ñ–ï–ù–ò–Ø! –ü—Ä–æ—è–≤–ª—è–π—Ç–µ —á—É–≤—Å—Ç–≤–∞ –æ—Ç–∫—Ä—ã—Ç–æ, –Ω–∞–∑–Ω–∞—á–∞–π—Ç–µ —Å–≤–∏–¥–∞–Ω–∏—è, –≥–æ–≤–æ—Ä–∏—Ç–µ –æ –ª—é–±–≤–∏. –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–∏–æ–¥ –≤ —Å–∞–º–æ–º —Ä–∞–∑–≥–∞—Ä–µ!",
                "–í–û–ó–ú–û–ñ–ù–û ü§î": f"üíï –ü—Ä–∏ –õ—É–Ω–µ –≤ {moon_sign} - –±—É–¥—å—Ç–µ –¢–ï–†–ü–ï–õ–ò–í–´, –Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã. –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è, –¥–∞–π—Ç–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ. –ò—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–±–µ–¥–∏—Ç!",
                "–ù–ï–¢ ‚ùå": f"üíî –õ—É–Ω–∞ –≤ {moon_sign} - –≤—Ä–µ–º—è –¥–ª—è –†–ê–ë–û–¢–´ –ù–ê–î –°–û–ë–û–ô. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–∏. –ù–æ–≤—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –ø–æ–∫–∞ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è - —Å–Ω–∞—á–∞–ª–∞ –∏—Å—Ü–µ–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ —Ä–∞–Ω—ã."
            },
            "–ö–ê–†–¨–ï–†–ê": {
                "–î–ê ‚úÖ": f"üöÄ –õ—É–Ω–∞ –≤ {moon_sign} - –ü–†–û–†–´–í –≤ –∫–∞—Ä—å–µ—Ä–µ! –°–º–µ–ª–æ –±–µ—Ä–∏—Ç–µ—Å—å –∑–∞ –Ω–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, –ø—Ä–æ—Å–∏—Ç–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ, –ø—Ä–æ—è–≤–ª—è–π—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∑–∞–º–µ—Ç–∏—Ç –≤–∞—à–∏ —Ç–∞–ª–∞–Ω—Ç—ã!",
                "–í–û–ó–ú–û–ñ–ù–û ü§î": f"üìà –ü—Ä–∏ –õ—É–Ω–µ –≤ {moon_sign} - –ü–û–°–¢–ï–ü–ï–ù–ù–´–ô –†–û–°–¢. –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å, —Ä–∞–±–æ—Ç–∞–π—Ç–µ —É—Å–µ—Ä–¥–Ω–æ –Ω–∞–¥ —Ç–µ–∫—É—â–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏. –í–∞—à–∏ —É—Å–∏–ª–∏—è —Å–∫–æ—Ä–æ –¥–∞–¥—É—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.",
                "–ù–ï–¢ ‚ùå": f"üìâ –õ—É–Ω–∞ –≤ {moon_sign} - –°–û–°–†–ï–î–û–¢–û–ß–¨–¢–ï–°–¨ –Ω–∞ –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ò. –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ª—É—á—à–µ –æ—Ç–ª–æ–∂–∏—Ç—å. –ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –æ–±—É—á–µ–Ω–∏—è –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏."
            }
        }
        return strategies.get(question_type, {}).get(verdict, "üåü –î–æ–≤–µ—Ä—å—Ç–µ—Å—å —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤—É–π—Ç–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –≥–æ–ª–æ—Å–æ–º!")

# –°–û–ó–î–ê–ï–ú –ú–û–ó–ì
bot_brain = HoraryBrain()

def get_moscow_time():
    """–ü–†–ê–í–ò–õ–¨–ù–û–ï –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è"""
    utc_time = datetime.utcnow()
    moscow_time = utc_time + timedelta(hours=3)
    return moscow_time.strftime('%H:%M, %d.%m.%Y')

def get_russian_zodiac(eng_sign):
    zodiac_map = {
        'Aries': '–û–≤–µ–Ω', 'Taurus': '–¢–µ–ª–µ—Ü', 'Gemini': '–ë–ª–∏–∑–Ω–µ—Ü—ã',
        'Cancer': '–†–∞–∫', 'Leo': '–õ–µ–≤', 'Virgo': '–î–µ–≤–∞',
        'Libra': '–í–µ—Å—ã', 'Scorpio': '–°–∫–æ—Ä–ø–∏–æ–Ω', 'Sagittarius': '–°—Ç—Ä–µ–ª–µ—Ü',
        'Capricorn': '–ö–æ–∑–µ—Ä–æ–≥', 'Aquarius': '–í–æ–¥–æ–ª–µ–π', 'Pisces': '–†—ã–±—ã'
    }
    return zodiac_map.get(eng_sign, eng_sign)

def get_planet_ruler(zodiac_sign):
    rulers = {
        '–û–≤–µ–Ω': '–ú–∞—Ä—Å', '–¢–µ–ª–µ—Ü': '–í–µ–Ω–µ—Ä–∞', '–ë–ª–∏–∑–Ω–µ—Ü—ã': '–ú–µ—Ä–∫—É—Ä–∏–π',
        '–†–∞–∫': '–õ—É–Ω–∞', '–õ–µ–≤': '–°–æ–ª–Ω—Ü–µ', '–î–µ–≤–∞': '–ú–µ—Ä–∫—É—Ä–∏–π',
        '–í–µ—Å—ã': '–í–µ–Ω–µ—Ä–∞', '–°–∫–æ—Ä–ø–∏–æ–Ω': '–ü–ª—É—Ç–æ–Ω', '–°—Ç—Ä–µ–ª–µ—Ü': '–Æ–ø–∏—Ç–µ—Ä',
        '–ö–æ–∑–µ—Ä–æ–≥': '–°–∞—Ç—É—Ä–Ω', '–í–æ–¥–æ–ª–µ–π': '–£—Ä–∞–Ω', '–†—ã–±—ã': '–ù–µ–ø—Ç—É–Ω'
    }
    return rulers.get(zodiac_sign, '–í–µ–Ω–µ—Ä–∞')

def get_zodiac_sign(planet):
    """–ò—Å–ø—Ä–∞–≤–ª—è–µ–º Ophiuchus"""
    try:
        constellation = ephem.constellation(planet)[1]
        if constellation == 'Ophiuchus':
            return '–°–∫–æ—Ä–ø–∏–æ–Ω'
        return get_russian_zodiac(constellation)
    except:
        return "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω"

def get_detailed_analysis(question_text):
    try:
        # –ü–†–ê–í–ò–õ–¨–ù–û–ï –≤—Ä–µ–º—è!
        display_time = get_moscow_time()
        
        observer = ephem.Observer()
        observer.lat = '55.7558'
        observer.lon = '37.6173'
        
        # –†–∞—Å—á–µ—Ç –≤—Å–µ—Ö –ø–ª–∞–Ω–µ—Ç
        planets = {
            '–õ—É–Ω–∞': ephem.Moon(),
            '–°–æ–ª–Ω—Ü–µ': ephem.Sun(),
            '–í–µ–Ω–µ—Ä–∞': ephem.Venus(),
            '–ú–∞—Ä—Å': ephem.Mars(),
            '–ú–µ—Ä–∫—É—Ä–∏–π': ephem.Mercury(),
            '–Æ–ø–∏—Ç–µ—Ä': ephem.Jupiter(),
            '–°–∞—Ç—É—Ä–Ω': ephem.Saturn()
        }
        
        for name, planet in planets.items():
            planet.compute(observer)
        
        # –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞–∫–∏ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º Ophiuchus
        moon_sign = get_zodiac_sign(planets['–õ—É–Ω–∞'])
        sun_sign = get_zodiac_sign(planets['–°–æ–ª–Ω—Ü–µ'])
        venus_sign = get_zodiac_sign(planets['–í–µ–Ω–µ—Ä–∞'])
        mars_sign = get_zodiac_sign(planets['–ú–∞—Ä—Å'])
        mercury_sign = get_zodiac_sign(planets['–ú–µ—Ä–∫—É—Ä–∏–π'])
        jupiter_sign = get_zodiac_sign(planets['–Æ–ø–∏—Ç–µ—Ä'])
        saturn_sign = get_zodiac_sign(planets['–°–∞—Ç—É—Ä–Ω'])
        
        # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —É–ø—Ä–∞–≤–∏—Ç–µ–ª–∏
        moon_ruler = get_planet_ruler(moon_sign)
        sun_ruler = get_planet_ruler(sun_sign)
        venus_ruler = get_planet_ruler(venus_sign)
        mars_ruler = get_planet_ruler(mars_sign)
        
        # –ò–°–ü–û–õ–¨–ó–£–ï–ú –ú–û–ó–ì –ë–û–¢–ê! üß†
        question_type, house, significator = bot_brain.analyze_question_type(question_text)
        verdict, reasoning = bot_brain.make_decision(moon_sign, venus_sign, question_type)
        strategy = bot_brain.generate_strategy(verdict, moon_sign, question_type)
        
        # –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó
        analysis = f"""
üîÆ –£–ú–ù–´–ô –•–û–†–ê–†–ù–´–ô –ê–ù–ê–õ–ò–ó
‚è∞ {display_time}, –ú–û–°–ö–í–ê

‚ùì –í–û–ü–†–û–°: {question_text}
üéØ –¢–ò–ü: {question_type} ({house}-–π –¥–æ–º)
‚öñÔ∏è –°–ò–ì–ù–ò–§–ò–ö–ê–¢–û–†: {significator}

üìä –î–ï–¢–ê–õ–¨–ù–ê–Ø –ö–ê–†–¢–ê:

‚Ä¢ üåô –õ—É–Ω–∞: {moon_sign} (—É–ø—Ä. {moon_ruler}) - —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω
‚Ä¢ ‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ: {sun_sign} (—É–ø—Ä. {sun_ruler}) - –≤–æ–ª—è –∏ —Ü–µ–ª—å
‚Ä¢ ‚ôÄÔ∏è –í–µ–Ω–µ—Ä–∞: {venus_sign} (—É–ø—Ä. {venus_ruler}) - –ª—é–±–æ–≤—å –∏ –¥–µ–Ω—å–≥–∏
‚Ä¢ ‚ôÇÔ∏è –ú–∞—Ä—Å: {mars_sign} (—É–ø—Ä. {mars_ruler}) - —ç–Ω–µ—Ä–≥–∏—è –¥–µ–π—Å—Ç–≤–∏–π
‚Ä¢ ‚òø –ú–µ—Ä–∫—É—Ä–∏–π: {mercury_sign} - –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è
‚Ä¢ ‚ôÉ –Æ–ø–∏—Ç–µ—Ä: {jupiter_sign} - —É–¥–∞—á–∞ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
‚Ä¢ ‚ôÑ –°–∞—Ç—É—Ä–Ω: {saturn_sign} - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –∫–∞—Ä–º–∞

‚ö° –í–ï–†–î–ò–ö–¢: {verdict}
üí° –û–ë–û–°–ù–û–í–ê–ù–ò–ï: {reasoning}

üé™ –°–¢–†–ê–¢–ï–ì–ò–Ø: {strategy}

üåü –ê–°–¢–†–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –°–û–í–ï–¢:
–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–µ—Ç {"–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–∏–º –Ω–∞–º–µ—Ä–µ–Ω–∏—è–º" if "–î–ê" in verdict else "—Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞" if "–ù–ï–¢" in verdict else "–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –º–∞–Ω–µ–≤—Ä–∞"}. –û–±—Ä–∞—Ç–∏—Ç–µ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–æ–ª–æ–∂–µ–Ω–∏–µ {moon_sign} –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ {venus_sign} –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∏.

ü§ñ –£—Ä–æ–≤–µ–Ω—å –∞–Ω–∞–ª–∏–∑–∞: {bot_brain.experience + 1}
"""
        return analysis
        
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}"

# –û–ë–†–ê–ë–û–¢–ö–ê –õ–ò–ß–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô
@bot.message_handler(func=lambda message: True)
def handle_message(message):
    if message.text.startswith('/'):
        if message.text == '/start':
            bot.reply_to(message, "üîÆ –Ø ‚Äî –£–ú–ù–´–ô –•–æ—Ä–∞—Ä–Ω—ã–π –ò–º–ø–µ—Ä–∞—Ç–æ—Ä! –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞!")
        return
    
    analysis = get_detailed_analysis(message.text)
    bot.reply_to(message, analysis)

print("üîÑ –£–ú–ù–´–ô –±–æ—Ç —Å –ü–û–õ–ù–´–ú –∞–Ω–∞–ª–∏–∑–æ–º –∑–∞–ø—É—â–µ–Ω...")
while True:
    try:
        bot.polling(none_stop=True, interval=1)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")
        time.sleep(5)
